<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>网络爬虫 | Lyouth - 贵在坚持</title><meta name="keywords" content="HttpClient,Jsoup,Webmagic"><meta name="author" content="Lyouth"><meta name="copyright" content="Lyouth"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="网络爬虫（又称为网页蜘蛛，网络机器人，在FOAF社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。">
<meta property="og:type" content="article">
<meta property="og:title" content="网络爬虫">
<meta property="og:url" content="https://www.liuyu.pw/blog/posts/3406920255.html">
<meta property="og:site_name" content="Lyouth - 贵在坚持">
<meta property="og:description" content="网络爬虫（又称为网页蜘蛛，网络机器人，在FOAF社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200424113627.png">
<meta property="article:published_time" content="2020-04-24T01:49:05.000Z">
<meta property="article:modified_time" content="2020-05-03T07:38:19.464Z">
<meta property="article:author" content="Lyouth">
<meta property="article:tag" content="爬虫">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200424113627.png"><link rel="shortcut icon" href="/blog/img/favicon.png"><link rel="canonical" href="https://www.liuyu.pw/blog/posts/3406920255"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>var GLOBAL_CONFIG = { 
  root: '/blog/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"该文章的有效性在正常时效内，但不排除过时情况，仅供参考","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-center"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}

// https://stackoverflow.com/questions/16839698/jquery-getscript-alternative-in-native-javascript
const getScript = url => new Promise((resolve, reject) => {
  const script = document.createElement('script')
  script.src = url
  script.async = true
  script.onerror = reject
  script.onload = script.onreadystatechange = function() {
    const loadState = this.readyState
    if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
    script.onload = script.onreadystatechange = null
    resolve()
  }
  document.head.appendChild(script)
})</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2020-05-03 15:38:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/avatar/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">21</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">19</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/blog/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/blog/saysay/"><i class="fa-fw fas fa-heart"></i><span> Say</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200424113627.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/blog/">Lyouth - 贵在坚持</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/blog/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/blog/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page" href="/blog/saysay/"><i class="fa-fw fas fa-heart"></i><span> Say</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">网络爬虫</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-04-24T01:49:05.000Z" title="发表于 2020-04-24 09:49:05">2020-04-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-05-03T07:38:19.464Z" title="更新于 2020-05-03 15:38:19">2020-05-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/categories/%E7%88%AC%E8%99%AB/">爬虫</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">17.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>72分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-网络爬虫"><a href="#1-网络爬虫" class="headerlink" title="1.网络爬虫"></a>1.网络爬虫</h1><h2 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h2><p>在大数据时代，信息的采集是一项重要的工作，而互联网中的数据是海量的，如果单纯靠人力进行信息采集，不仅低效繁琐，搜集的成本也会提高。如何自动高效地获取互联网中我们感兴趣的信息并为我们所用是一个重要的问题，而爬虫技术就是为了解决这些问题而生的。</p>
<p>网络爬虫（Web crawler）也叫做网络机器人，可以代替人们自动地在互联网中进行数据信息的采集与整理。它是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本，可以自动采集所有其能够访问到的页面内容，以获取相关数据。</p>
<p>从功能上来讲，爬虫一般分为数据采集，处理，储存三个部分。爬虫从一个或若干初始网页的URL开始，获得初始网页上的URL，在抓取网页的过程中，不断从当前页面上抽取新的URL放入队列,直到满足系统的一定停止条件。</p>
<h2 id="1-2-为什么学网络爬虫"><a href="#1-2-为什么学网络爬虫" class="headerlink" title="1.2 为什么学网络爬虫"></a>1.2 为什么学网络爬虫</h2><ol>
<li><p>   可以实现搜索引擎<br>我们学会了爬虫编写之后，就可以利用爬虫自动地采集互联网中的信息，采集回来后进行相应的存储或处理，在需要检索某些信息的时候，只需在采集回来的信息中进行检索，即实现了私人的搜索引擎。</p>
</li>
<li><p>   大数据时代，可以让我们获取更多的数据源。<br>在进行大数据分析或者进行数据挖掘的时候，需要有数据源进行分析。我们可以从某些提供数据统计的网站获得，也可以从某些文献或内部资料中获得，但是这些获得数据的方式，有时很难满足我们对数据的需求，而手动从互联网中去寻找这些数据，则耗费的精力过大。此时就可以利用爬虫技术，自动地从互联网中获取我们感兴趣的数据内容，并将这些数据内容爬取回来，作为我们的数据源，再进行更深层次的数据分析，并获得更多有价值的信息。</p>
</li>
<li><p>对于很多SEO从业者来说，为了更好的完成工作，那么就必须要对搜索引擎的工作原理非常清楚，同时也需要掌握搜索引擎爬虫的工作原理。而学习爬虫，可以更深层次地理解搜索引擎爬虫的工作原理，这样在进行搜索引擎优化时，才能知己知彼，百战不殆。</p>
</li>
</ol>
<h2 id="1-3-爬虫分类"><a href="#1-3-爬虫分类" class="headerlink" title="1.3 爬虫分类"></a>1.3 爬虫分类</h2><p>网络爬虫按照系统结构和实现技术，大致可以分为以下几种类型：通用网络爬虫、聚焦网络爬虫、增量式网络爬虫、深层网络爬虫。 实际的网络爬虫系统通常是几种爬虫技术相结合实现的</p>
<h3 id="1-通用网络爬虫"><a href="#1-通用网络爬虫" class="headerlink" title="1.通用网络爬虫"></a>1.通用网络爬虫</h3><p>通用网络爬虫又称全网爬虫（Scalable Web Crawler），爬行对象从一些种子 URL 扩充到整个 Web，主要为门户站点搜索引擎和大型 Web 服务提供商采集数据。<br>这类网络爬虫的爬行范围和数量巨大，对于爬行速度和存储空间要求较高，对于爬行页面的顺序要求相对较低，同时由于待刷新的页面太多，通常采用并行工作方式，但需要较长时间才能刷新一次页面。<br><strong>简单的说就是互联网上抓取所有数据。</strong></p>
<h3 id="2-聚焦网络爬虫"><a href="#2-聚焦网络爬虫" class="headerlink" title="2.聚焦网络爬虫"></a>2.聚焦网络爬虫</h3><p>聚焦网络爬虫（Focused Crawler），又称主题网络爬虫（Topical Crawler），是指选择性地爬行那些与预先定义好的主题相关页面的网络爬虫。<br>和通用网络爬虫相比，聚焦爬虫只需要爬行与主题相关的页面，极大地节省了硬件和网络资源，保存的页面也由于数量少而更新快，还可以很好地满足一些特定人群对特定领域信息的需求 。<br><strong>简单的说就是互联网上只抓取某一种数据。</strong></p>
<h3 id="3-增量式网络爬虫"><a href="#3-增量式网络爬虫" class="headerlink" title="3.增量式网络爬虫"></a>3.增量式网络爬虫</h3><p>增量式网络爬虫（Incremental Web Crawler）是 指 对 已 下 载 网 页 采 取 增量式更新和只爬行新产生的或者已经发生变化网页的爬虫，它能够在一定程度上保证所爬行的页面是尽可能新的页面。<br>和周期性爬行和刷新页面的网络爬虫相比，增量式爬虫只会在需要的时候爬行新产生或发生更新的页面 ，并不重新下载没有发生变化的页面，可有效减少数据下载量，及时更新已爬行的网页，减小时间和空间上的耗费，但是增加了爬行算法的复杂度和实现难度。<br><strong>简单的说就是互联网上只抓取刚刚更新的数据。</strong></p>
<h3 id="4-Deep-Web-爬虫"><a href="#4-Deep-Web-爬虫" class="headerlink" title="4.Deep Web 爬虫"></a>4.Deep Web 爬虫</h3><p>Web 页面按存在方式可以分为表层网页（Surface Web）和深层网页（Deep Web，也称 Invisible Web Pages 或 Hidden Web）。<br>表层网页是指传统搜索引擎可以索引的页面，以超链接可以到达的静态网页为主构成的 Web 页面。<br><strong>Deep Web 是那些大部分内容不能通过静态链接获取的、隐藏在搜索表单后的，只有用户提交一些关键词才能获得的 Web 页面。</strong></p>
<h1 id="2-HttpClient"><a href="#2-HttpClient" class="headerlink" title="2.HttpClient"></a>2.HttpClient</h1><p>网络爬虫就是用程序帮助我们访问网络上的资源，我们一直以来都是使用HTTP协议访问互联网的网页，网络爬虫需要编写程序，在这里使用同样的HTTP协议访问网页。</p>
<p>这里我们使用Java的HTTP协议客户端 HttpClient这个技术，来实现抓取网页数据。</p>
<h2 id="2-1-入门程序"><a href="#2-1-入门程序" class="headerlink" title="2.1 入门程序"></a>2.1 入门程序</h2><p>创建<code>Maven</code>工程，在POM文件中添加依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.httpcomponents/httpclient --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.slf4j/slf4j-log4j12 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--&lt;scope&gt;test&lt;/scope&gt;--&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>resources</code>目录下创建日志输出文件<code>log4j.properties</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log4j.rootLogger=DEBUG,A1</span><br><span class="line">log4j.logger.cn.itcast = DEBUG</span><br><span class="line"></span><br><span class="line">log4j.appender.A1=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.A1.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.A1.layout.ConversionPattern=%-d&#123;yyyy-MM-dd HH:mm:ss,SSS&#125; [%t] [%c]-[%p] %m%n</span><br></pre></td></tr></table></figure>
<p>编写测试代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CrawlerFirst</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1. 打开浏览器,创建HttpClient对象</span></span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.createDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 输入网址,发起get请求创建HttpGet对象</span></span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(<span class="string">&quot;http://news.baidu.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.按回车，发起请求，返回响应，使用HttpClient对象发起请求</span></span><br><span class="line">        CloseableHttpResponse response = httpClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 解析响应，获取数据</span></span><br><span class="line">        <span class="comment">//判断状态码是否是200</span></span><br><span class="line">        <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">            HttpEntity httpEntity = response.getEntity();</span><br><span class="line">            String content = EntityUtils.toString(httpEntity, <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">            System.out.println(content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：可以获取到页面数据</p>
<h2 id="2-2-GET请求"><a href="#2-2-GET请求" class="headerlink" title="2.2 GET请求"></a>2.2 GET请求</h2><p>使用GET请求访问百度新闻，请求url地址： <a target="_blank" rel="noopener" href="http://news.baidu.com/">http://news.baidu.com/</a></p>
<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpGetTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  </span>&#123;</span><br><span class="line">        <span class="comment">//创建HttpClient对象</span></span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.createDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建HttpGet对象，设置url访问地址</span></span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(<span class="string">&quot;http://news.baidu.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//使用HttpClient发起请求，获取response</span></span><br><span class="line">             response = httpClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//解析响应</span></span><br><span class="line">            <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                String content = EntityUtils.toString(response.getEntity(), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">                System.out.println(content.length());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//关闭response</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                httpClient.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>仔细观察控制台，可以发现是get请求，并且返回200状态码，说明响应成功。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http-outgoing-<span class="number">0</span> &gt;&gt; GET / HTTP/<span class="number">1.1</span></span><br><span class="line">http-outgoing-<span class="number">0</span> &gt;&gt; Host: news.baidu.com</span><br><span class="line">http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;HTTP/1.1 200 OK[\r][\n]&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-3-带参数的GET请求"><a href="#2-3-带参数的GET请求" class="headerlink" title="2.3 带参数的GET请求"></a>2.3 带参数的GET请求</h2><p>在知乎中搜索关于<code>COVID-19</code>的信息，地址为:<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?type=content&amp;q=covid19">https://www.zhihu.com/search?type=content&amp;q=covid19</a></p>
<p>我们请求路径是:<a target="_blank" rel="noopener" href="https://www.zhihu.com/search,%E5%90%8E%E9%9D%A2%E7%9A%84%E6%98%AF%E6%90%9C%E7%B4%A2%E7%B1%BB%E5%9E%8B(type)%E5%92%8C%E5%85%B3%E9%94%AE%E5%AD%97(q)%E3%80%82">https://www.zhihu.com/search,后面的是搜索类型(type)和关键字(q)。</a></p>
<p><strong>因为知乎搜索时，必须制定搜索类型，所以我们这里封装了两个参数。如果只有一个查询参数，只需setParameter一次即可</strong></p>
<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpGetParamTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//创建HttpClient对象</span></span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.createDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置请求地址是：https://www.zhihu.com/search?type=content&amp;q=covid19</span></span><br><span class="line">        <span class="comment">//创建URIBuilder</span></span><br><span class="line">        URIBuilder uriBuilder = <span class="keyword">new</span> URIBuilder(<span class="string">&quot;https://www.zhihu.com/search&quot;</span>);</span><br><span class="line">        <span class="comment">//设置参数</span></span><br><span class="line">        uriBuilder.setParameter(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;search&quot;</span>).setParameter(<span class="string">&quot;q&quot;</span>,<span class="string">&quot;covid19&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建HttpGet对象，设置url访问地址</span></span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(uriBuilder.build());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;发起请求的信息：&quot;</span>+httpGet);</span><br><span class="line"></span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//使用HttpClient发起请求，获取response</span></span><br><span class="line">             response = httpClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//解析响应</span></span><br><span class="line">            <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                String content = EntityUtils.toString(response.getEntity(), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">                System.out.println(content.length());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//关闭response</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                httpClient.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>仔细观察控制台，可以发现是get请求，并且请求中带有查询参数，并且返回200状态码，说明响应成功。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http-outgoing-<span class="number">0</span> &gt;&gt; GET /search?type=search&amp;q=covid19 HTTP/<span class="number">1.1</span></span><br><span class="line">http-outgoing-<span class="number">0</span> &gt;&gt; Host: www.zhihu.com</span><br><span class="line">http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;HTTP/1.1 200 OK[\r][\n]&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-4-POST请求"><a href="#2-4-POST请求" class="headerlink" title="2.4 POST请求"></a>2.4 POST请求</h2><p>使用POST请求访问百度新闻，请求url地址： <a target="_blank" rel="noopener" href="http://news.baidu.com/">http://news.baidu.com/</a></p>
<p>测试类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpPostTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  </span>&#123;</span><br><span class="line">        <span class="comment">//创建HttpClient对象</span></span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.createDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建HttpPost对象，设置url访问地址</span></span><br><span class="line">        HttpPost httpPost = <span class="keyword">new</span> HttpPost(<span class="string">&quot;http://news.baidu.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//使用HttpClient发起请求，获取response</span></span><br><span class="line">             response = httpClient.execute(httpPost);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//解析响应</span></span><br><span class="line">            <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                String content = EntityUtils.toString(response.getEntity(), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">                System.out.println(content.length());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//关闭response</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                httpClient.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>仔细观察控制台，可以发现是post请求，并且返回200状态码，说明响应成功。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http-outgoing-<span class="number">0</span> &gt;&gt; POST / HTTP/<span class="number">1.1</span></span><br><span class="line">http-outgoing-<span class="number">0</span> &gt;&gt; Host: news.baidu.com</span><br><span class="line">http-outgoing-<span class="number">0</span> &lt;&lt; <span class="string">&quot;HTTP/1.1 200 OK[\r][\n]&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="2-5-带参数的POST请求"><a href="#2-5-带参数的POST请求" class="headerlink" title="2.5 带参数的POST请求"></a>2.5 带参数的POST请求</h2><p>在知乎中搜索关于<code>COVID-19</code>的信息，地址为:<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?type=content&amp;q=covid19">https://www.zhihu.com/search?type=content&amp;q=covid19</a></p>
<p>我们请求路径是:<a target="_blank" rel="noopener" href="https://www.zhihu.com/search,%E5%90%8E%E9%9D%A2%E7%9A%84%E6%98%AF%E6%90%9C%E7%B4%A2%E7%B1%BB%E5%9E%8B(type)%E5%92%8C%E5%85%B3%E9%94%AE%E5%AD%97(q)%E3%80%82">https://www.zhihu.com/search,后面的是搜索类型(type)和关键字(q)。</a></p>
<p>url地址没有参数，参数keys=java放到表单中进行提交</p>
<p>测试类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpPostParamTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//创建HttpClient对象</span></span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.createDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建HttpPost对象，设置url访问地址</span></span><br><span class="line">        HttpPost httpPost = <span class="keyword">new</span> HttpPost(<span class="string">&quot;http://www.zhihu.com/search&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//声明List集合，封装表单中的参数</span></span><br><span class="line">        List&lt;NameValuePair&gt; params = <span class="keyword">new</span> ArrayList&lt;NameValuePair&gt;();</span><br><span class="line">        <span class="comment">//设置请求地址是：https://www.zhihu.com/search?type=content&amp;q=covid19</span></span><br><span class="line">        params.add(<span class="keyword">new</span> BasicNameValuePair(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;content&quot;</span>));</span><br><span class="line">        params.add(<span class="keyword">new</span> BasicNameValuePair(<span class="string">&quot;q&quot;</span>,<span class="string">&quot;covid19&quot;</span>));</span><br><span class="line">        <span class="comment">//创建表单的Entity对象,第一个参数就是封装好的表单数据，第二个参数就是编码</span></span><br><span class="line">        UrlEncodedFormEntity formEntity = <span class="keyword">new</span> UrlEncodedFormEntity(params,<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置表单的Entity对象到Post请求中</span></span><br><span class="line">        httpPost.setEntity(formEntity);</span><br><span class="line"></span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//使用HttpClient发起请求，获取response</span></span><br><span class="line">             response = httpClient.execute(httpPost);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//解析响应</span></span><br><span class="line">            <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                String content = EntityUtils.toString(response.getEntity(), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">                System.out.println(content.length());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//关闭response</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                httpClient.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>仔细观察控制台，可以发现是post请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http-outgoing-<span class="number">0</span> &gt;&gt; POST /search?type=content HTTP/<span class="number">1.1</span></span><br><span class="line">http-outgoing-<span class="number">0</span> &gt;&gt; Host: www.zhihu.com</span><br><span class="line">http-outgoing-<span class="number">0</span> &gt;&gt; <span class="string">&quot;q=java&quot;</span></span><br></pre></td></tr></table></figure>
<p>因为知乎启动了防爬虫机制，所以此处没有返回200，而是返回了<code>http-outgoing-0 &lt;&lt; &quot;HTTP/1.1 301 Moved Permanently[\r][\n]&quot;</code>。</p>
<p>解决方案：请求时，带上cookie</p>
<h2 id="2-6-连接池"><a href="#2-6-连接池" class="headerlink" title="2.6 连接池"></a>2.6 连接池</h2><p>如果每次请求都要创建HttpClient，会有频繁创建和销毁的问题，可以使用连接池来解决这个问题。测试以下代码，并断点查看每次获取的HttpClient都是不一样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientPoolTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建连接池管理器</span></span><br><span class="line">        PoolingHttpClientConnectionManager cm = <span class="keyword">new</span> PoolingHttpClientConnectionManager();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置最大连接数</span></span><br><span class="line">        cm.setMaxTotal(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置每个主机的最大连接数</span></span><br><span class="line">        cm.setDefaultMaxPerRoute(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用连接池管理器发起请求</span></span><br><span class="line">        doGet(cm);</span><br><span class="line">        doGet(cm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(PoolingHttpClientConnectionManager cm)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//不是每次创建新的HttpClient，而是从连接池中获取HttpClient对象</span></span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.custom().setConnectionManager(cm).build();</span><br><span class="line"></span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(<span class="string">&quot;http://news.baidu.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response = httpClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                String content = EntityUtils.toString(response.getEntity(), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">                System.out.println(content.length());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    response.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//不能关闭HttpClient，由连接池管理HttpClient</span></span><br><span class="line">                <span class="comment">//httpClient.close();</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-7-请求参数"><a href="#2-7-请求参数" class="headerlink" title="2.7 请求参数"></a>2.7 请求参数</h2><p>有时候因为网络，或者目标服务器的原因，请求需要更长的时间才能完成，我们需要自定义相关时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpConfigTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span>  </span>&#123;</span><br><span class="line">        <span class="comment">//创建HttpClient对象</span></span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.createDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建HttpGet对象，设置url访问地址</span></span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(<span class="string">&quot;http://news.baidu.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置请求信息</span></span><br><span class="line">        RequestConfig config = RequestConfig.custom().setConnectTimeout(<span class="number">1000</span>)   <span class="comment">//创建连接的最长时间，单位是毫秒</span></span><br><span class="line">                .setConnectionRequestTimeout(<span class="number">500</span>)   <span class="comment">//设置获取连接的最长时间，单位是毫秒</span></span><br><span class="line">                .setSocketTimeout(<span class="number">10</span>*<span class="number">1000</span>)      <span class="comment">//设置数据传输的最长时间，单位是毫秒</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给请求设置请求信息</span></span><br><span class="line">        httpGet.setConfig(config);</span><br><span class="line"></span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//使用HttpClient发起请求，获取response</span></span><br><span class="line">             response = httpClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//解析响应</span></span><br><span class="line">            <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                String content = EntityUtils.toString(response.getEntity(), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">                System.out.println(content.length());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//关闭response</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                httpClient.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="3-JSOUP"><a href="#3-JSOUP" class="headerlink" title="3.JSOUP"></a>3.JSOUP</h1><p>我们抓取到页面之后，还需要对页面进行解析。可以使用字符串处理工具解析页面，也可以使用正则表达式，但是这些方法都会带来很大的开发成本，所以我们需要使用一款专门解析html页面的技术。</p>
<h2 id="3-1-jsoup介绍"><a href="#3-1-jsoup介绍" class="headerlink" title="3.1 jsoup介绍"></a>3.1 jsoup介绍</h2><p>jsoup 是一款Java 的HTML解析器，可直接解析某个<code>URL地址</code>、<code>HTML文本内容</code>。它提供了一套非常省力的API，可通过DOM，CSS以及类似于jQuery的操作方法来取出和操作数据。</p>
<p>jsoup的主要功能如下：</p>
<ol>
<li>   从一个URL，文件或字符串中解析HTML；</li>
<li>   使用DOM或CSS选择器来查找、取出数据；</li>
<li>   可操作HTML元素、属性、文本；</li>
</ol>
<h2 id="3-2-jsoup解析"><a href="#3-2-jsoup解析" class="headerlink" title="3.2 jsoup解析"></a>3.2 jsoup解析</h2><p>我们在刚才项目的pom文件中，加入JSOUP依赖和一些工具类依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.jsoup/jsoup --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jsoup<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsoup<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-io/commons-io --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-lang3 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-解析URL"><a href="#1-解析URL" class="headerlink" title="1 解析URL"></a>1 解析URL</h3><p>Jsoup可以直接输入url，它会发起请求并获取数据，封装为Document对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUrl</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//解析url地址,第一个参数是访问的url，第二个参数是访问时候的超时时间</span></span><br><span class="line">        Document doc = Jsoup.parse(<span class="keyword">new</span> URL(<span class="string">&quot;http://news.baidu.com&quot;</span>), <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用标签选择器，获取title标签中的内容</span></span><br><span class="line">        String title = doc.getElementsByTag(<span class="string">&quot;title&quot;</span>).first().text();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//打印</span></span><br><span class="line">        System.out.println(title);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PS：虽然使用Jsoup可以替代HttpClient直接发起请求解析数据，但是往往不会这样用，因为实际的开发过程中，需要使用到<code>多线程</code>，<code>连接池</code>，<code>代理</code>等等方式，而jsoup对这些的支持并不是很好，所以我们一般把jsoup仅仅作为Html解析工具使用</p>
<h3 id="2-解析字符串"><a href="#2-解析字符串" class="headerlink" title="2 解析字符串"></a>2 解析字符串</h3><p>先准备以下html文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>百度新闻——海量中文资讯平台<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;city&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">id</span>=<span class="string">&quot;city_bj&quot;</span>&gt;</span>北京办事处<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fb:img</span> <span class="attr">src</span>=<span class="string">&quot;/2018czgw/images/slogan.jpg&quot;</span> <span class="attr">class</span>=<span class="string">&quot;slogan&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;city_in&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;city_con&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">id</span>=<span class="string">&quot;test&quot;</span> <span class="attr">class</span>=<span class="string">&quot;class_a class_b&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://bj.example.com&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;s_name&quot;</span>&gt;</span>北京<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://sh.example.com&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;s_name&quot;</span>&gt;</span>上海<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://gz.example.com&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">span</span> <span class="attr">abc</span>=<span class="string">&quot;123&quot;</span> <span class="attr">class</span>=<span class="string">&quot;s_name&quot;</span>&gt;</span>广州<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span>天津<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Jsoup可以直接输入字符串，并封装为Document对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testString</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//使用工具类读取文件，获取字符串  </span></span><br><span class="line">        String content = FileUtils.readFileToString(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\tree\\Desktop\\test.html&quot;</span>), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析字符串</span></span><br><span class="line">        Document doc = Jsoup.parse(content);</span><br><span class="line"></span><br><span class="line">        String title = doc.getElementsByTag(<span class="string">&quot;title&quot;</span>).first().text();</span><br><span class="line"></span><br><span class="line">        System.out.println(title);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-解析文件"><a href="#3-解析文件" class="headerlink" title="3 解析文件"></a>3 解析文件</h3><p>Jsoup可以直接解析文件，并封装为Document对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFile</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">//解析文件</span></span><br><span class="line">       Document doc = Jsoup.parse(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\tree\\Desktop\\test.html&quot;</span>), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">       String title = doc.getElementsByTag(<span class="string">&quot;title&quot;</span>).first().text();</span><br><span class="line"></span><br><span class="line">       System.out.println(title);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-使用dom方式遍历文档"><a href="#4-使用dom方式遍历文档" class="headerlink" title="4 使用dom方式遍历文档"></a>4 使用dom方式遍历文档</h3><p><strong>获取元素</strong></p>
<ol>
<li>   根据id查询元素<code>getElementById</code></li>
<li>   根据标签获取元素<code>getElementsByTag</code></li>
<li>   根据class获取元素<code>getElementsByClass</code></li>
<li>   根据属性获取元素<code>getElementsByAttribute</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDOM</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">//解析文件，获取Document对象</span></span><br><span class="line">       Document doc = Jsoup.parse(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\tree\\Desktop\\test.html&quot;</span>), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">//获取元素</span></span><br><span class="line">       <span class="comment">//1.根据id查询元素getElementById,输出 北京办事处</span></span><br><span class="line">       Element element = doc.getElementById(<span class="string">&quot;city_bj&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//2.根据标签获取元素getElementsByTag 输出 北京</span></span><br><span class="line">       Element element = doc.getElementsByTag(<span class="string">&quot;span&quot;</span>).first();</span><br><span class="line"></span><br><span class="line">       <span class="comment">//3.根据class获取元素getElementsByClass</span></span><br><span class="line">       Element element = doc.getElementsByClass(<span class="string">&quot;class_a class_b&quot;</span>).first();</span><br><span class="line">       Element element = doc.getElementsByClass(<span class="string">&quot;class_a&quot;</span>).first();</span><br><span class="line">       Element element = doc.getElementsByClass(<span class="string">&quot;class_b&quot;</span>).first();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="comment">//4.根据属性获取元素getElementsByAttribute</span></span><br><span class="line">       <span class="comment">//获取属性为abc的值</span></span><br><span class="line">       <span class="comment">//Element element = doc.getElementsByAttribute(&quot;abc&quot;).first();</span></span><br><span class="line">       <span class="comment">//第一个属性名，第一个属性值。属性名加属性值进行筛选</span></span><br><span class="line">       Element element = doc.getElementsByAttributeValue(<span class="string">&quot;href&quot;</span>, <span class="string">&quot;http://gz.example.com&quot;</span>).first();</span><br><span class="line"></span><br><span class="line">       <span class="comment">//打印元素的内容</span></span><br><span class="line">       System.out.println(<span class="string">&quot;获取到的元素内容是：&quot;</span> + element.text());</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>元素中获取数据</strong></p>
<ol>
<li>   从元素中获取id</li>
<li>   从元素中获取className</li>
<li>   从元素中获取属性的值attr</li>
<li>   从元素中获取所有属性attributes</li>
<li>   从元素中获取文本内容text</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testData</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">//解析文件，获取Document</span></span><br><span class="line">       Document doc = Jsoup.parse(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\tree\\Desktop\\test.html&quot;</span>), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//根据id获取元素</span></span><br><span class="line">       Element element = doc.getElementById(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">       String str = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//元素中获取数据</span></span><br><span class="line">       <span class="comment">//1.从元素中获取id</span></span><br><span class="line">       str = element.id();</span><br><span class="line"></span><br><span class="line">       <span class="comment">//2.从元素中获取className</span></span><br><span class="line">       str = element.className();</span><br><span class="line">       <span class="comment">//Set&lt;String&gt; classSet = element.classNames();</span></span><br><span class="line">       <span class="comment">//for (String s : classSet ) &#123;</span></span><br><span class="line">       <span class="comment">//    System.out.println(s);</span></span><br><span class="line">       <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//3.从元素中获取属性的值attr</span></span><br><span class="line">       <span class="comment">//str = element.attr(&quot;id&quot;);</span></span><br><span class="line">       str = element.attr(<span class="string">&quot;class&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//4.从元素中获取所有属性attributes</span></span><br><span class="line">       Attributes attributes = element.attributes();</span><br><span class="line">       System.out.println(attributes.toString());</span><br><span class="line"></span><br><span class="line">       <span class="comment">//5.从元素中获取文本内容text</span></span><br><span class="line">       str = element.text();</span><br><span class="line"></span><br><span class="line">       <span class="comment">//打印获取到的内容</span></span><br><span class="line">       System.out.println(<span class="string">&quot;获取到的数据是：&quot;</span> + str);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-使用选择器语法查找元素"><a href="#5-使用选择器语法查找元素" class="headerlink" title="5 使用选择器语法查找元素"></a>5 使用选择器语法查找元素</h3><p>jsoup elements对象支持类似于CSS (或jquery)的选择器语法，来实现非常强大和灵活的查找功能。这个select 方法在Document, Element,或Elements对象中都可以使用。且是上下文相关的，因此可实现指定元素的过滤，或者链式选择访问。</p>
<p>Select方法将返回一个Elements集合，并提供一组方法来抽取和处理结果。</p>
<h3 id="6-Selector选择器概述"><a href="#6-Selector选择器概述" class="headerlink" title="6 Selector选择器概述"></a>6 Selector选择器概述</h3><p><strong>tagname</strong>: 通过标签查找元素，比如：span<br><strong>#id</strong>: 通过ID查找元素，比如：# city_bj<br><strong>.class</strong>: 通过class名称查找元素，比如：.class_a<br><strong>[attribute]</strong>: 利用属性查找元素，比如：[abc]<br><strong>[attr=value]</strong>: 利用属性值来查找元素，比如：[class=s_name]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelector</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//解析html文件，获取Document对象</span></span><br><span class="line">      Document doc = Jsoup.parse(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\tree\\Desktop\\test.html&quot;</span>), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//tagname: 通过标签查找元素，比如：span</span></span><br><span class="line">      Elements elements = doc.select(<span class="string">&quot;span&quot;</span>);</span><br><span class="line">      <span class="comment">//for (Element element : elements) &#123;</span></span><br><span class="line">      <span class="comment">//    System.out.println(element.text());</span></span><br><span class="line">      <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//#id: 通过ID查找元素，比如：#city_bj</span></span><br><span class="line">      Element element = doc.select(<span class="string">&quot;#city_bj&quot;</span>).first();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//.class: 通过class名称查找元素，比如：.class_a</span></span><br><span class="line">      Element element = doc.select(<span class="string">&quot;.class_a&quot;</span>).first();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//[attribute]: 利用属性查找元素，比如：[abc]</span></span><br><span class="line">      Element element = doc.select(<span class="string">&quot;[abc]&quot;</span>).first();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//[attr=value]: 利用属性值来查找元素，比如：[class=s_name]</span></span><br><span class="line">      Elements elements1 = doc.select(<span class="string">&quot;[class=s_name]&quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> (Element element1 : elements1) &#123;</span><br><span class="line">          System.out.println(element1.text());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//打印结果</span></span><br><span class="line">      System.out.println(<span class="string">&quot;获取到的结果是：&quot;</span> + element.text());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-Selector选择器组合使用"><a href="#7-Selector选择器组合使用" class="headerlink" title="7 Selector选择器组合使用"></a>7 Selector选择器组合使用</h3><p><strong>el#id</strong>: 元素+ID，比如： h3#city_bj<br><strong>el.class</strong>: 元素+class，比如： li.class_a<br><strong>el[attr]</strong>: 元素+属性名，比如： span[abc]<br><strong>任意组合</strong>: 比如：span[abc].s_name<br><strong>ancestor child</strong>: 查找某个元素下子元素，比如：.city_con li 查找”city_con”下的所有li<br><strong>parent &gt; child</strong>: 查找某个父元素下的直接子元素，比如：<br><strong>.city_con &gt; ul &gt; li</strong>: 查找city_con第一级（直接子元素）的ul，再找所有ul下的第一级li<br>*<em>parent &gt; **</em>: 查找某个父元素下所有直接子元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelector2</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//解析html文件，获取Document对象</span></span><br><span class="line">        Document doc = Jsoup.parse(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\tree\\Desktop\\test.html&quot;</span>), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//el#id: 元素+ID，比如： h3#city_bj</span></span><br><span class="line">        Element element = doc.select(<span class="string">&quot;h3#city_bj&quot;</span>).first();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//el.class: 元素+class，比如： li.class_a</span></span><br><span class="line">        element = doc.select(<span class="string">&quot;li.class_a&quot;</span>).first();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//el[attr]: 元素+属性名，比如： span[abc]</span></span><br><span class="line">        element = doc.select(<span class="string">&quot;span[abc]&quot;</span>).first();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//任意组合: 比如：span[abc].s_name</span></span><br><span class="line">        element = doc.select(<span class="string">&quot;span[abc].s_name&quot;</span>).first();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ancestor child: 查找某个元素下子元素，比如：.city_con li 查找&quot;city_con&quot;下的所有li</span></span><br><span class="line">        Elements elements = doc.select(<span class="string">&quot;.city_con li&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//parent &gt; child: 查找某个父元素下的直接子元素，比如：</span></span><br><span class="line">        <span class="comment">//.city_con &gt; ul &gt; li 查找city_con第一级（直接子元素）的ul，再找所有ul下的第一级li</span></span><br><span class="line">        elements = doc.select(<span class="string">&quot;.city_con &gt; ul &gt; li&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//parent &gt; *: 查找某个父元素下所有直接子元素</span></span><br><span class="line">        elements = doc.select(<span class="string">&quot;.city_con &gt; ul &gt; *&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;获取到的内容是：&quot;</span>+element.text());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Element element1 : elements) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;遍历的结果：&quot;</span>+element1.text());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-爬虫案例"><a href="#3-3-爬虫案例" class="headerlink" title="3.3 爬虫案例"></a>3.3 爬虫案例</h2><h3 id="1-数据库表分析"><a href="#1-数据库表分析" class="headerlink" title="1.数据库表分析"></a>1.数据库表分析</h3><p>根据需求分析，我们创建的表如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `jd_item` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键id&#x27;</span>,</span><br><span class="line">  `spu` <span class="type">bigint</span>(<span class="number">15</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品集合id&#x27;</span>,</span><br><span class="line">  `sku` <span class="type">bigint</span>(<span class="number">15</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品最小品类单元id&#x27;</span>,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品标题&#x27;</span>,</span><br><span class="line">  `price` <span class="type">bigint</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品价格&#x27;</span>,</span><br><span class="line">  `pic` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品图片&#x27;</span>,</span><br><span class="line">  `url` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品详情地址&#x27;</span>,</span><br><span class="line">  `created` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `updated` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`),</span><br><span class="line">  KEY `sku` (`sku`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;京东商品表&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="2-添加依赖"><a href="#2-添加依赖" class="headerlink" title="2.添加依赖"></a>2.添加依赖</h3><p>本案例使用<strong>Spring Boot+Spring Data JPA</strong>和<strong>定时任务</strong>进行开发<br>创建maven项目，并在pom文件中添加如下依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringMVC--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--SpringData Jpa--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--MySQL连接包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- HttpClient --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--Jsoup--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jsoup<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsoup<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--工具包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="3-添加配置文件"><a href="#3-添加配置文件" class="headerlink" title="3.添加配置文件"></a>3.添加配置文件</h3><p>在<code>resources</code>目录下，创建application.properties</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.datasource.driverClassName=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="string">spring.datasource.url=jdbc:mysql://118.89.216.120:3306/crawler</span></span><br><span class="line"><span class="string">spring.datasource.username=root</span></span><br><span class="line"><span class="string">spring.datasource.password=562644</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#JPA Configuration:</span></span><br><span class="line"><span class="string">spring.jpa.database=MySQL</span></span><br><span class="line"><span class="string">spring.jpa.show-sql=true</span></span><br></pre></td></tr></table></figure>
<h3 id="4-编写POJO"><a href="#4-编写POJO" class="headerlink" title="4.编写POJO"></a>4.编写POJO</h3><p>根据数据库表，编写pojo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table(name = &quot;jd_item&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">    <span class="comment">//主键</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">//标准产品单位（商品集合）</span></span><br><span class="line">    <span class="keyword">private</span> Long spu;</span><br><span class="line">    <span class="comment">//库存量单位（最小品类单元）</span></span><br><span class="line">    <span class="keyword">private</span> Long sku;</span><br><span class="line">    <span class="comment">//商品标题</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">//商品价格</span></span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">    <span class="comment">//商品图片</span></span><br><span class="line">    <span class="keyword">private</span> String pic;</span><br><span class="line">    <span class="comment">//商品详情地址</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="comment">//创建时间</span></span><br><span class="line">    <span class="keyword">private</span> Date created;</span><br><span class="line">    <span class="comment">//更新时间</span></span><br><span class="line">    <span class="keyword">private</span> Date updated;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略get/set方法</span></span><br></pre></td></tr></table></figure>
<h3 id="5-编写DAO"><a href="#5-编写DAO" class="headerlink" title="5.编写DAO"></a>5.编写DAO</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemDao</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Item</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-编写Service"><a href="#6-编写Service" class="headerlink" title="6.编写Service"></a>6.编写Service</h3><p>ItemService接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存商品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(Item item)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据条件查询商品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Item&gt; <span class="title">findAll</span><span class="params">(Item item)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ItemService接口实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemServiceImpl</span> <span class="keyword">implements</span> <span class="title">ItemService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemDao itemDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(Item item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.itemDao.save(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Item&gt; <span class="title">findAll</span><span class="params">(Item item)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//声明查询条件</span></span><br><span class="line">        Example&lt;Item&gt; example = Example.of(item);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据查询条件进行查询数据</span></span><br><span class="line">        List&lt;Item&gt; list = <span class="keyword">this</span>.itemDao.findAll(example);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-编写引导类"><a href="#7-编写引导类" class="headerlink" title="7.编写引导类"></a>7.编写引导类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">//使用定时任务，需要先开启定时任务，需要添加注解</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-封装HttpClient"><a href="#8-封装HttpClient" class="headerlink" title="8.封装HttpClient"></a>8.封装HttpClient</h3><p>我们需要经常使用HttpClient，所以需要进行封装，方便使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> PoolingHttpClientConnectionManager cm;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpUtils</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cm = <span class="keyword">new</span> PoolingHttpClientConnectionManager();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置最大连接数</span></span><br><span class="line">        <span class="keyword">this</span>.cm.setMaxTotal(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置每个主机的最大连接数</span></span><br><span class="line">        <span class="keyword">this</span>.cm.setDefaultMaxPerRoute(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据请求地址下载页面数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 页面数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doGetHtml</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取HttpClient对象</span></span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.custom().setConnectionManager(<span class="keyword">this</span>.cm).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建httpGet请求对象，设置url地址</span></span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置请求信息</span></span><br><span class="line">        httpGet.setConfig(<span class="keyword">this</span>.getConfig());</span><br><span class="line">        httpGet.addHeader(<span class="string">&quot;User-Agent&quot;</span>,<span class="string">&quot; Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.122 Safari/537.36&quot;</span>);</span><br><span class="line">        httpGet.addHeader(<span class="string">&quot;Content-Type&quot;</span>,<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//使用HttpClient发起请求，获取响应</span></span><br><span class="line">            response = httpClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//解析响应，返回结果</span></span><br><span class="line">            <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="comment">//判断响应体Entity是否不为空，如果不为空就可以使用EntityUtils</span></span><br><span class="line">                <span class="keyword">if</span> (response.getEntity() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    String content = EntityUtils.toString(response.getEntity(), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> content;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//关闭response</span></span><br><span class="line">            <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    response.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//返回空串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载图片</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 图片名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doGetImage</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取HttpClient对象</span></span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.custom().setConnectionManager(<span class="keyword">this</span>.cm).build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建httpGet请求对象，设置url地址</span></span><br><span class="line">        HttpGet httpGet = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置请求信息</span></span><br><span class="line">        httpGet.setConfig(<span class="keyword">this</span>.getConfig());</span><br><span class="line"></span><br><span class="line">        CloseableHttpResponse response = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//使用HttpClient发起请求，获取响应</span></span><br><span class="line">            response = httpClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//解析响应，返回结果</span></span><br><span class="line">            <span class="keyword">if</span> (response.getStatusLine().getStatusCode() == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="comment">//判断响应体Entity是否不为空</span></span><br><span class="line">                <span class="keyword">if</span> (response.getEntity() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//下载图片</span></span><br><span class="line">                    <span class="comment">//获取图片的后缀</span></span><br><span class="line">                    String extName = url.substring(url.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//创建图片名，重命名图片</span></span><br><span class="line">                    String picName = UUID.randomUUID().toString() + extName;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//下载图片</span></span><br><span class="line">                    <span class="comment">//声明OutPutStream</span></span><br><span class="line">                    OutputStream outputStream = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\tree\\Desktop\\images\\&quot;</span> +</span><br><span class="line">                            picName));</span><br><span class="line">                    response.getEntity().writeTo(outputStream);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//返回图片名称</span></span><br><span class="line">                    <span class="keyword">return</span> picName;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//关闭response</span></span><br><span class="line">            <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    response.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果下载失败，返回空串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置请求信息</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RequestConfig <span class="title">getConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestConfig config = RequestConfig.custom()</span><br><span class="line">                .setConnectTimeout(<span class="number">1000</span>)    <span class="comment">//创建连接的最长时间</span></span><br><span class="line">                .setConnectionRequestTimeout(<span class="number">500</span>)  <span class="comment">// 获取连接的最长时间</span></span><br><span class="line">                .setSocketTimeout(<span class="number">10000</span>)    <span class="comment">//数据传输的最长时间</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-实现数据抓取"><a href="#9-实现数据抓取" class="headerlink" title="9.实现数据抓取"></a>9.实现数据抓取</h3><p>使用定时任务，可以定时抓取最新的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">//创建实例对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemTask</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HttpUtils httpUtils;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ItemService itemService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析json工具类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectMapper MAPPER =  <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//当下载任务完成后，间隔多长时间进行下一次的任务。</span></span><br><span class="line">    <span class="comment">//@Scheduled(fixedDelay = 100 * 1000)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">itemTask</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//声明需要解析的初始地址</span></span><br><span class="line">        String url = <span class="string">&quot;https://search.jd.com/Search?keyword=%E6%89%8B%E6%9C%BA&amp;enc=utf-8&amp;qrst=1&amp;rt=1&amp;stop=1&amp;vt=2&amp;wq&quot;</span> +</span><br><span class="line">                <span class="string">&quot;=%E6%89%8B%E6%9C%BA&amp;cid2=653&amp;cid3=655&amp;s=113&amp;click=0&amp;page=&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//按照页面对手机的搜索结果进行遍历解析</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">10</span>; i = i + <span class="number">2</span>) &#123;</span><br><span class="line">            String html = httpUtils.doGetHtml(url + i);</span><br><span class="line">            <span class="comment">//解析页面，获取商品数据并存储</span></span><br><span class="line">            <span class="keyword">this</span>.parse(html);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;手机数据抓取完成！&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析页面，获取商品数据并存储</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(String html)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//解析html获取Document</span></span><br><span class="line">        Document doc = Jsoup.parse(html);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取spu信息</span></span><br><span class="line">        Elements spuEles = doc.select(<span class="string">&quot;div#J_goodsList &gt; ul &gt; li&quot;</span>); <span class="comment">//li下全部子元素</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Element spuEle : spuEles) &#123;</span><br><span class="line">            <span class="comment">//获取spu  通过获取属性名获取spu</span></span><br><span class="line">            <span class="keyword">long</span> spu = Long.parseLong(spuEle.attr(<span class="string">&quot;data-spu&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取sku信息</span></span><br><span class="line">            Elements skuEles = spuEle.select(<span class="string">&quot;li.ps-item&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Element skuEle : skuEles) &#123;</span><br><span class="line">                <span class="comment">//获取sku</span></span><br><span class="line">                <span class="keyword">long</span> sku = Long.parseLong(skuEle.select(<span class="string">&quot;[data-sku]&quot;</span>).attr(<span class="string">&quot;data-sku&quot;</span>));</span><br><span class="line"></span><br><span class="line">                <span class="comment">//根据sku查询商品数据</span></span><br><span class="line">                Item item = <span class="keyword">new</span> Item();</span><br><span class="line">                item.setSku(sku);</span><br><span class="line">                List&lt;Item&gt; list = <span class="keyword">this</span>.itemService.findAll(item);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(list.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//如果商品存在，就进行下一个循环，该商品不保存，因为已存在</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//设置商品的spu</span></span><br><span class="line">                item.setSpu(spu);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取商品的详情的url</span></span><br><span class="line">                String itemUrl = <span class="string">&quot;https://item.jd.com/&quot;</span> + sku + <span class="string">&quot;.html&quot;</span>;</span><br><span class="line">                item.setUrl(itemUrl);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取商品的图片</span></span><br><span class="line">                String picUrl =<span class="string">&quot;https:&quot;</span>+ skuEle.select(<span class="string">&quot;img[data-sku]&quot;</span>).first().attr(<span class="string">&quot;data-lazy-img&quot;</span>);</span><br><span class="line">                picUrl = picUrl.replace(<span class="string">&quot;/n9/&quot;</span>,<span class="string">&quot;/n1/&quot;</span>);</span><br><span class="line">                String picName = <span class="keyword">this</span>.httpUtils.doGetImage(picUrl);</span><br><span class="line">                item.setPic(picName);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取商品的价格</span></span><br><span class="line">                String priceJson = <span class="keyword">this</span>.httpUtils.doGetHtml(<span class="string">&quot;https://p.3.cn/prices/mgets?skuIds=J_&quot;</span> + sku);</span><br><span class="line">                <span class="keyword">double</span> price = MAPPER.readTree(priceJson).get(<span class="number">0</span>).get(<span class="string">&quot;p&quot;</span>).asDouble();</span><br><span class="line">                item.setPrice(price);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取商品的标题</span></span><br><span class="line">                String itemInfo = <span class="keyword">this</span>.httpUtils.doGetHtml(item.getUrl());</span><br><span class="line">                String title = Jsoup.parse(itemInfo).select(<span class="string">&quot;div.sku-name&quot;</span>).text();</span><br><span class="line">                item.setTitle(title);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                item.setCreated(<span class="keyword">new</span> Date());</span><br><span class="line">                item.setUpdated(item.getCreated());</span><br><span class="line"></span><br><span class="line">                <span class="comment">//保存商品数据到数据库中</span></span><br><span class="line">                <span class="keyword">this</span>.itemService.save(item);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-WebMagic"><a href="#4-WebMagic" class="headerlink" title="4.WebMagic"></a>4.WebMagic</h1><p>官网:<a target="_blank" rel="noopener" href="http://webmagic.io/">http://webmagic.io/</a></p>
<h2 id="4-1-WebMagic介绍"><a href="#4-1-WebMagic介绍" class="headerlink" title="4.1 WebMagic介绍"></a>4.1 WebMagic介绍</h2><p>WebMagic项目代码分为核心和扩展两部分。核心部分(webmagic-core)是一个精简的、模块化的爬虫实现，而扩展部分则包括一些便利的、实用性的功能。</p>
<p>WebMagic的设计目标是尽量的模块化，并体现爬虫的功能特点。这部分提供非常简单、灵活的API，在基本不改变开发模式的情况下，编写一个爬虫。</p>
<p>扩展部分(webmagic-extension)提供一些便捷的功能，例如注解模式编写爬虫等。同时内置了一些常用的组件，便于爬虫开发。</p>
<p>WebMagic底层是HttpClient和Jsoup，让我们能够更方便的开发爬虫。</p>
<h2 id="4-2-架构介绍"><a href="#4-2-架构介绍" class="headerlink" title="4.2 架构介绍"></a>4.2 架构介绍</h2><p>WebMagic的结构分为<code>Downloader</code>、<code>PageProcessor</code>、<code>Schedule</code>r、<code>Pipeline</code>四大组件，并由Spider将它们彼此组织起来。这四大组件对应爬虫生命周期中的下载、处理、管理和持久化等功能。WebMagic的设计参考了Scapy，但是实现方式更Java化一些。</p>
<p>而Spider则将这几个组件组织起来，让它们可以互相交互，流程化的执行，可以认为Spider是一个大的容器，它也是WebMagic逻辑的核心。</p>
<p>WebMagic总体架构图如下：<br><img src="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200424170152.png"></p>
<h3 id="1-WebMagic的四个组件"><a href="#1-WebMagic的四个组件" class="headerlink" title="1.WebMagic的四个组件"></a>1.WebMagic的四个组件</h3><p>1.Downloader<br>Downloader负责从互联网上<strong>下载</strong>页面，以便后续处理。WebMagic默认使用了Apache HttpClient作为下载工具。</p>
<p>2.PageProcessor<br>PageProcessor负责<strong>解析</strong>页面，抽取有用信息，以及发现新的链接。WebMagic使用<strong>Jsoup</strong>作为HTML解析工具，并基于其开发了解析<strong>XPath</strong>的工具<strong>Xsoup</strong>。</p>
<p>在这四个组件中，<strong>PageProcessor对于每个站点每个页面都不一样，是需要使用者定制的部分</strong>。</p>
<p>3.Scheduler<br><strong>Scheduler负责管理待抓取的URL</strong>，以及一些<strong>去重</strong>的工作。WebMagic默认提供了JDK的内存队列来管理URL，并用<strong>集合</strong>来进行去重。也支持使用<strong>Redis</strong>进行分布式管理。</p>
<p>4.Pipeline<br>Pipeline负责抽取结果的处理，包括计算、持久化到文件、数据库等。WebMagic默认提供了“<strong>输出到控制台</strong>”和“<strong>保存到文件</strong>”两种结果处理方案。</p>
<p>Pipeline定义了结果保存的方式，如果你要保存到指定数据库，则需要编写对应的Pipeline。对于一类需求一般只需编写一个Pipeline。</p>
<h3 id="2-用于数据流转的对象"><a href="#2-用于数据流转的对象" class="headerlink" title="2.用于数据流转的对象"></a>2.用于数据流转的对象</h3><p>1.Request<br>Request是对URL地址的一层封装，一个Request对应一个URL地址。</p>
<p>它是PageProcessor与Downloader交互的载体，也是PageProcessor控制Downloader唯一方式。</p>
<p>除了URL本身外，它还包含一个Key-Value结构的字段extra。你可以在extra中保存一些特殊的属性，然后在其他地方读取，以完成不同的功能。例如附加上一个页面的一些信息等。</p>
<p>2.Page<br>Page代表了从Downloader下载到的一个页面——可能是HTML，也可能是JSON或者其他文本格式的内容。</p>
<p>Page是WebMagic抽取过程的核心对象，它提供一些方法可供抽取、结果保存等。</p>
<p>3.ResultItems<br>ResultItems相当于一个Map，它保存PageProcessor处理的结果，供Pipeline使用。它的API与Map很类似，值得注意的是它有一个字段skip，若设置为true，则不应被Pipeline处理。</p>
<h2 id="4-3实现PageProcessor"><a href="#4-3实现PageProcessor" class="headerlink" title="4.3实现PageProcessor"></a>4.3实现PageProcessor</h2><h3 id="1-入门案例"><a href="#1-入门案例" class="headerlink" title="1.入门案例"></a>1.入门案例</h3><p>创建Maven工程，并加入以下依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/us.codecraft/webmagic-core --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--核心包--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>us.codecraft<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webmagic-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/us.codecraft/webmagic-extension --&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--扩展包--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>us.codecraft<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webmagic-extension<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--WebMagic对布隆过滤器的支持--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>注意：0.7.3版本的核心包对SSL的并不完全，如果是直接从Maven中央仓库下载依赖，在爬取只支持SSL v1.2的网站会有SSL的异常抛出。</strong></p>
<p>解决方案：</p>
<ol>
<li>   等作者的0.7.4的版本发布</li>
<li>   直接从github上下载最新的代码，安装到本地仓库</li>
</ol>
<p>也可以参考以下资料自己修复:<a target="_blank" rel="noopener" href="https://github.com/code4craft/webmagic/issues/701">https://github.com/code4craft/webmagic/issues/701</a></p>
<p>加入配置文件:WebMagic使用slf4j-log4j12作为slf4j的实现，添加<code>WebMagic</code>依赖的同时<code>log4j</code>的依赖也自动添加过来了，所以无需手动添加。<br>添加log4j.properties配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log4j.rootLogger=INFO,A1 </span><br><span class="line"></span><br><span class="line">log4j.appender.A1=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.A1.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.A1.layout.ConversionPattern=%-d&#123;yyyy-MM-dd HH:mm:ss,SSS&#125; [%t] [%c]-[%p] %m%n</span><br></pre></td></tr></table></figure>
<p>测试类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实现解析组件 PageProcessor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobProcessor</span> <span class="keyword">implements</span> <span class="title">PageProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析页面</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Page page)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取html中的div标签，同时class为mt下的h2标签</span></span><br><span class="line">        <span class="comment">//解析返回的数据page，并且把解析的结果放到ResultItems中</span></span><br><span class="line">        <span class="comment">//前面是key，可以随便写。后面是value。此处用的是select选择器方式</span></span><br><span class="line">        page.putField(<span class="string">&quot;div&quot;</span>, page.getHtml().css(<span class="string">&quot;div.mt&gt;h2&quot;</span>).all()); <span class="comment">//all,获取所有符合条件的</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Site site = Site.me();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Site <span class="title">getSite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行入口</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Spider.create(<span class="keyword">new</span> JobProcessor())  <span class="comment">//创建自己定义的解析器</span></span><br><span class="line">                <span class="comment">//初始访问url地址</span></span><br><span class="line">                .addUrl(<span class="string">&quot;https://www.jd.com/moreSubject.aspx&quot;</span>)  <span class="comment">//设置爬取数据页面的地址</span></span><br><span class="line">                .run();   <span class="comment">//执行爬虫</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：如果不写，日志默认输出到控制台</p>
<h3 id="2-抽取元素Selectable"><a href="#2-抽取元素Selectable" class="headerlink" title="2.抽取元素Selectable"></a>2.抽取元素Selectable</h3><p>WebMagic里主要使用了三种抽取技术：<code>XPath</code>、<code>正则表达式</code>和<code>CSS选择器</code>。另外，对于JSON格式的内容，可使用JsonPath进行解析。<br>1.XPath</p>
<p>XPath语法参考:<a target="_blank" rel="noopener" href="https://www.w3school.com.cn/xpath/xpath_syntax.asp">https://www.w3school.com.cn/xpath/xpath_syntax.asp</a></p>
<p>示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取div标签,并且div的id等于news_div,该div下面的ul标签，ul标签下的li标签，li下的div标签，div标签下的a标签的所有内容</span></span><br><span class="line"><span class="comment">// &quot;//&quot;从匹配选择的当前节点选择文档中的节点，而不考虑它们的位置。</span></span><br><span class="line">page.putField(<span class="string">&quot;div2&quot;</span>, page.getHtml().xpath(<span class="string">&quot;//div[@id=news_div]/ul/li/div/a&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>也可以参考W3School手册</p>
<p>2.CSS选择器<br>CSS选择器是与XPath类似的语言。在上一次的课程中，我们已经学习过了Jsoup的选择器，它比XPath写起来要简单一些，但是如果写复杂一点的抽取规则，就相对要麻烦一点。</p>
<p>示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取html中的div标签，并且div标签的class等于mt下的，所有h2标签</span></span><br><span class="line">page.putField(<span class="string">&quot;div&quot;</span>, page.getHtml().css(<span class="string">&quot;div.mt&gt;h2&quot;</span>).all()); <span class="comment">//all,获取所有符合条件的</span></span><br></pre></td></tr></table></figure>
<p>使用:nth-child(n)选择第几个元素，如下选择第一个元素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取html中的div标签，并且div标签的id等于news_div，div下的ul标签，ul下第一个li的a标签内容</span></span><br><span class="line">page.putField(<span class="string">&quot;div&quot;</span>,page.getHtml().css(<span class="string">&quot;div#news_div &gt; ul &gt; li:nth-child(1) a&quot;</span>).toString());</span><br></pre></td></tr></table></figure>
<p><strong>注意：需要使用&gt;，就是直接子元素才可以选择第几个元素</strong></p>
<p>3.正则表达式<br>正则表达式则是一种通用的文本抽取语言。在这里一般用于获取url地址。<br>语法参考:<a target="_blank" rel="noopener" href="https://www.runoob.com/regexp/regexp-syntax.html">https://www.runoob.com/regexp/regexp-syntax.html</a></p>
<p>示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取html中的div标签，并且div标签的id等于news_div，包含江苏的所有a标签。江苏前后不做限制。</span></span><br><span class="line">page.putField(<span class="string">&quot;div3&quot;</span>, page.getHtml().css(<span class="string">&quot;div#news_div a&quot;</span>).regex(<span class="string">&quot;.*江苏.*&quot;</span>).all());</span><br></pre></td></tr></table></figure>
<h3 id="3-抽取元素Selectable对应API"><a href="#3-抽取元素Selectable对应API" class="headerlink" title="3.抽取元素Selectable对应API"></a>3.抽取元素Selectable对应API</h3><p>Selectable相关的抽取元素链式API是WebMagic的一个核心功能。使用Selectable接口，可以直接完成页面元素的链式抽取，也无需去关心抽取的细节。<br>在刚才的例子中可以看到，<code>page.getHtml()</code>返回的是一个Html对象，它实现了<code>Selectable</code>接口。这个接口包含的方法分为两类：抽取部分和获取结果部分。</p>
<table>
<thead>
<tr>
<th align="center">方法</th>
<th align="center">说明</th>
<th align="center">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">xpath(String xpath)</td>
<td align="center">使用XPath选择</td>
<td align="center">html.xpath(“//div[@class=’title’]”)</td>
</tr>
<tr>
<td align="center">$(String selector)</td>
<td align="center">使用Css选择器选择</td>
<td align="center">html.$(“div.title”)</td>
</tr>
<tr>
<td align="center">$(String selector,String attr)</td>
<td align="center">使用Css选择器选择</td>
<td align="center">html.$(“div.title”,”text”)</td>
</tr>
<tr>
<td align="center">css(String selector)</td>
<td align="center">功能同$()，使用Css选择器选择</td>
<td align="center">html.css(“div.title”)</td>
</tr>
<tr>
<td align="center">links()</td>
<td align="center">选择所有链接</td>
<td align="center">html.links()</td>
</tr>
<tr>
<td align="center">regex(String regex)</td>
<td align="center">使用正则表达式抽取</td>
<td align="center"><code>html.regex(&quot;\(.\*?)\&quot;)</code></td>
</tr>
</tbody></table>
<h3 id="4-获取结果API"><a href="#4-获取结果API" class="headerlink" title="4.获取结果API"></a>4.获取结果API</h3><p>当链式调用结束时，我们一般都想要拿到一个字符串类型的结果。这时候就需要用到获取结果的API了。</p>
<p>我们知道，一条抽取规则，无论是XPath、CSS选择器或者正则表达式，总有可能抽取到多条元素。WebMagic对这些进行了统一，可以通过不同的API获取到一个或者多个元素。<br>获取一条结果,默认是获取第一条。</p>
<table>
<thead>
<tr>
<th align="center">方法</th>
<th align="center">说明</th>
<th align="center">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">get()</td>
<td align="center">返回一条String类型的结果</td>
<td align="center">String link= html.links().get())</td>
</tr>
<tr>
<td align="center">toString()</td>
<td align="center">同get()，返回一条String类型的结果</td>
<td align="center">String link= html.links().toString()</td>
</tr>
<tr>
<td align="center">all()</td>
<td align="center">返回所有抽取结果</td>
<td align="center">List links= html.links().all())</td>
</tr>
</tbody></table>
<p>示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取结果API</span></span><br><span class="line"><span class="comment">//获取html中的div标签，并且div标签的id等于news_div，包含江苏的所有a标签。返回一条String类型结果</span></span><br><span class="line">page.putField(<span class="string">&quot;div4&quot;</span>, page.getHtml().css(<span class="string">&quot;div#news_div a&quot;</span>).regex(<span class="string">&quot;.*江苏.*&quot;</span>).get());</span><br><span class="line">page.putField(<span class="string">&quot;div5&quot;</span>, page.getHtml().css(<span class="string">&quot;div#news_div a&quot;</span>).regex(<span class="string">&quot;.*江苏.*&quot;</span>).toString());</span><br></pre></td></tr></table></figure>
<p>这里selectable.toString()采用了toString()这个接口，是为了在输出以及和一些框架结合的时候，更加方便。因为一般情况下，我们都只需要选择一个元素！<br>selectable.all()则会获取到所有元素。</p>
<h3 id="5-获取链接"><a href="#5-获取链接" class="headerlink" title="5.获取链接"></a>5.获取链接</h3><p>有了处理页面的逻辑，我们的爬虫就接近完工了，但是现在还有一个问题：一个站点的页面是很多的，一开始我们不可能全部列举出来，于是如何发现后续的链接，是一个爬虫不可缺少的一部分。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//分两步操作</span></span><br><span class="line"><span class="comment">//1.添加地址，先抓取链接</span></span><br><span class="line"><span class="comment">//获取html中的div标签，并且div标签的id等于news_div下所有以9结尾的超链接元素。</span></span><br><span class="line"><span class="comment">//其实不加a也可以。因为div.links()方法会默认找到该div所有的超链接,所以这里我们去掉了a标签</span></span><br><span class="line">page.addTargetRequests(page.getHtml().css(<span class="string">&quot;div#news_div&quot;</span>).links().regex(<span class="string">&quot;.*9$&quot;</span>).all());</span><br><span class="line"><span class="comment">//2.输出所有h1标题</span></span><br><span class="line"><span class="comment">//获取html中的div标签，并且div标签的class等于mt下，所有h1元素内容。</span></span><br><span class="line">page.putField(<span class="string">&quot;url&quot;</span>,page.getHtml().css(<span class="string">&quot;div.mt h1&quot;</span>).all());</span><br></pre></td></tr></table></figure>
<p>执行程序。可以发现程序是先发送请求，后获取内容。</p>
<h2 id="4-4使用Pipeline保存结果"><a href="#4-4使用Pipeline保存结果" class="headerlink" title="4.4使用Pipeline保存结果"></a>4.4使用Pipeline保存结果</h2><p>WebMagic用于保存结果的组件叫做Pipeline。我们现在通过“控制台输出结果”这件事也是通过一个内置的Pipeline完成的，它叫做ConsolePipeline。</p>
<p>那么，我现在想要把结果用保存到文件中，怎么做呢？只将Pipeline的实现换成”FilePipeline”就可以了。<br>修改<code>4.3.1</code>入门案例中的主方法，增加<code>addPipeline()</code>方法</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//主函数，执行爬虫</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">            Spider.create(<span class="keyword">new</span> JobProcessor())</span><br><span class="line">            <span class="comment">//初始访问url地址</span></span><br><span class="line">            .addUrl(<span class="string">&quot;https://www.jd.com/moreSubject.aspx&quot;</span>)  <span class="comment">//设置爬取数据的页面地址</span></span><br><span class="line">            .addPipeline(<span class="keyword">new</span> FilePipeline(<span class="string">&quot;D:/webmagic/&quot;</span>))  <span class="comment">//输出到文件中</span></span><br><span class="line">            .thread(<span class="number">5</span>)<span class="comment">//设置5个线程</span></span><br><span class="line">            .run();  <span class="comment">//执行爬虫</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-5爬虫的配置、启动和终止"><a href="#4-5爬虫的配置、启动和终止" class="headerlink" title="4.5爬虫的配置、启动和终止"></a>4.5爬虫的配置、启动和终止</h2><h3 id="1-Spider"><a href="#1-Spider" class="headerlink" title="1.Spider"></a>1.Spider</h3><p>Spider是爬虫启动的入口。在启动爬虫之前，我们需要使用一个PageProcessor创建一个Spider对象，然后使用run()进行启动。<br>同时Spider的其他组件（Downloader、Scheduler、Pipeline）都可以通过set方法来进行设置。</p>
<table>
<thead>
<tr>
<th align="center">方法</th>
<th align="center">说明</th>
<th align="center">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">create(PageProcessor)</td>
<td align="center">创建Spider</td>
<td align="center">Spider.create(new GithubRepoProcessor())</td>
</tr>
<tr>
<td align="center">addUrl(String…)</td>
<td align="center">添加初始的URL</td>
<td align="center"><code>spider .addUrl(&quot;http://webmagic.io/docs/&quot;)</code></td>
</tr>
<tr>
<td align="center">thread(n)</td>
<td align="center">开启n个线程</td>
<td align="center">spider.thread(n)</td>
</tr>
<tr>
<td align="center">run()</td>
<td align="center">启动，会阻塞当前线程执行</td>
<td align="center">spider.run()</td>
</tr>
<tr>
<td align="center">start()/runAsync()</td>
<td align="center">异步启动，当前线程继续执行</td>
<td align="center">spider.start()</td>
</tr>
<tr>
<td align="center">stop()</td>
<td align="center">停止爬虫</td>
<td align="center">spider.stop()</td>
</tr>
<tr>
<td align="center">addPipeline(Pipeline)</td>
<td align="center">添加一个Pipeline，一个Spider可以有多个Pipeline</td>
<td align="center">spider .addPipeline(new ConsolePipeline())</td>
</tr>
<tr>
<td align="center">setScheduler(Scheduler)</td>
<td align="center">设置Scheduler，一个Spider只能有个一个Scheduler</td>
<td align="center">spider.setScheduler(new RedisScheduler())</td>
</tr>
<tr>
<td align="center">setDownloader(Downloader)</td>
<td align="center">设置Downloader，一个Spider只能有个一个Downloader</td>
<td align="center">spider .setDownloader(new SeleniumDownloader())</td>
</tr>
<tr>
<td align="center">get(String)</td>
<td align="center">同步调用，并直接取得结果</td>
<td align="center"><code>ResultItems result = spider.get(&quot;http://webmagic.io/docs/&quot;)</code></td>
</tr>
<tr>
<td align="center">getAll(String…)</td>
<td align="center">同步调用，并直接取得一堆结果</td>
<td align="center"><code>List&lt;ResultItems&gt; results = spider .getAll(&quot;http://webmagic.io/docs/&quot;, &quot;http://webmagic.io/xxx&quot;)</code></td>
</tr>
</tbody></table>
<h3 id="2-爬虫配置Site"><a href="#2-爬虫配置Site" class="headerlink" title="2.爬虫配置Site"></a>2.爬虫配置Site</h3><p>Site.me()可以对爬虫进行一些配置配置，包括编码、抓取间隔、超时时间、重试次数等。在这里我们先简单设置一下：重试次数为3次，抓取间隔为一秒。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Site site = Site.me()</span><br><span class="line">            .setCharset(<span class="string">&quot;utf8&quot;</span>)    <span class="comment">//设置编码</span></span><br><span class="line">            .setTimeOut(<span class="number">10000</span>)   <span class="comment">//设置超时时间，单位是ms毫秒 10s</span></span><br><span class="line">            .setRetrySleepTime(<span class="number">3000</span>)  <span class="comment">//设置重试的间隔时间</span></span><br><span class="line">            .setSleepTime(<span class="number">3</span>)      <span class="comment">//设置重试次数</span></span><br><span class="line">            ;</span><br></pre></td></tr></table></figure>
<p>站点本身的一些配置信息，例如编码、HTTP头、超时时间、重试策略等、代理等，都可以通过设置Site对象来进行配置。</p>
<table>
<thead>
<tr>
<th align="center">方法</th>
<th align="center">说明</th>
<th align="center">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">setCharset(String)</td>
<td align="center">设置编码</td>
<td align="center"><code>site.setCharset(&quot;utf-8&quot;)</code></td>
</tr>
<tr>
<td align="center">setUserAgent(String)</td>
<td align="center">设置UserAgent</td>
<td align="center"><code>site.setUserAgent(&quot;Spider&quot;)</code></td>
</tr>
<tr>
<td align="center">setTimeOut(int)</td>
<td align="center">设置超时时间，单位是毫秒</td>
<td align="center">site.setTimeOut(3000)</td>
</tr>
<tr>
<td align="center">setRetryTimes(int)</td>
<td align="center">设置重试次数</td>
<td align="center">site.setRetryTimes(3))</td>
</tr>
<tr>
<td align="center">setCycleRetryTimes(int)</td>
<td align="center">设置循环重试次数</td>
<td align="center">site.setCycleRetryTimes(3)</td>
</tr>
<tr>
<td align="center">addCookie(String,String)</td>
<td align="center">添加一条cookie</td>
<td align="center"><code>site.addCookie(&quot;dotcomt_user&quot;,&quot;code4craft&quot;)</code></td>
</tr>
<tr>
<td align="center">setDomain(String)</td>
<td align="center">设置域名，需设置域名后，addCookie才可生效</td>
<td align="center"><code>site.setDomain(&quot;github.com&quot;)</code></td>
</tr>
<tr>
<td align="center">addHeader(String,String)</td>
<td align="center">添加一条addHeader</td>
<td align="center"><code>site.addHeader(&quot;Referer&quot;,&quot;https://github.com&quot;)</code></td>
</tr>
<tr>
<td align="center">setHttpProxy(HttpHost)</td>
<td align="center">设置Http代理</td>
<td align="center"><code>site.setHttpProxy(new HttpHost(&quot;127.0.0.1&quot;,8080))</code></td>
</tr>
</tbody></table>
<h2 id="4-6-测试代码参考"><a href="#4-6-测试代码参考" class="headerlink" title="4.6 测试代码参考"></a>4.6 测试代码参考</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobProcessor</span> <span class="keyword">implements</span> <span class="title">PageProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析页面</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Page page)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//解析返回的数据page，并且把解析的结果放到ResultItems中</span></span><br><span class="line">        <span class="comment">//css选择器</span></span><br><span class="line">        page.putField(<span class="string">&quot;div&quot;</span>, page.getHtml().css(<span class="string">&quot;div.mt h2&quot;</span>).all());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//XPath</span></span><br><span class="line">        page.putField(<span class="string">&quot;div2&quot;</span>, page.getHtml().xpath(<span class="string">&quot;//div[@id=news_div]/ul/li/div/a&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//正则表达式</span></span><br><span class="line">        page.putField(<span class="string">&quot;div3&quot;</span>, page.getHtml().css(<span class="string">&quot;div#news_div a&quot;</span>).regex(<span class="string">&quot;.*江苏.*&quot;</span>).all());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理结果API</span></span><br><span class="line">        page.putField(<span class="string">&quot;div4&quot;</span>, page.getHtml().css(<span class="string">&quot;div#news_div a&quot;</span>).regex(<span class="string">&quot;.*江苏.*&quot;</span>).get());</span><br><span class="line">        page.putField(<span class="string">&quot;div5&quot;</span>, page.getHtml().css(<span class="string">&quot;div#news_div a&quot;</span>).regex(<span class="string">&quot;.*江苏.*&quot;</span>).toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取链接</span></span><br><span class="line">        <span class="comment">//page.addTargetRequests(page.getHtml().css(&quot;div#news_div&quot;).links().regex(&quot;.*9$&quot;).all());</span></span><br><span class="line">        <span class="comment">//page.putField(&quot;url&quot;,page.getHtml().css(&quot;div.mt h1&quot;).all());</span></span><br><span class="line"></span><br><span class="line">        page.addTargetRequest(<span class="string">&quot;https://www.jd.com/news.html?id=37319&quot;</span>);</span><br><span class="line">        page.addTargetRequest(<span class="string">&quot;https://www.jd.com/news.html?id=37319&quot;</span>);</span><br><span class="line">        page.addTargetRequest(<span class="string">&quot;https://www.jd.com/news.html?id=37319&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Site site = Site.me()</span><br><span class="line">            .setCharset(<span class="string">&quot;utf8&quot;</span>)    <span class="comment">//设置编码</span></span><br><span class="line">            .setTimeOut(<span class="number">10000</span>)   <span class="comment">//设置超时时间，单位是ms毫秒</span></span><br><span class="line">            .setRetrySleepTime(<span class="number">3000</span>)  <span class="comment">//设置重试的间隔时间</span></span><br><span class="line">            .setSleepTime(<span class="number">3</span>)      <span class="comment">//设置重试次数</span></span><br><span class="line">            ;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Site <span class="title">getSite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主函数，执行爬虫</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Spider spider = Spider.create(<span class="keyword">new</span> JobProcessor())</span><br><span class="line">                .addUrl(<span class="string">&quot;https://www.jd.com/moreSubject.aspx&quot;</span>)  <span class="comment">//设置爬取数据的页面</span></span><br><span class="line">                <span class="comment">//.addPipeline(new FilePipeline(&quot;C:\\Users\\tree\\Desktop\\result&quot;))</span></span><br><span class="line">                .thread(<span class="number">5</span>)</span><br><span class="line">                .setScheduler(<span class="keyword">new</span> QueueScheduler().setDuplicateRemover(<span class="keyword">new</span> BloomFilterDuplicateRemover(<span class="number">10000000</span>)));<span class="comment">//设置布隆去重过滤器，指定最多对1000万数据进行去重操作</span></span><br><span class="line">        Scheduler scheduler = spider.getScheduler();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行爬虫</span></span><br><span class="line">        spider.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="5-案例分析"><a href="#5-案例分析" class="headerlink" title="5.案例分析"></a>5.案例分析</h1><p>我们已经学完了WebMagic的基本使用方法，现在准备使用WebMagic实现爬取数据的功能。这里是一个比较完整的实现。<br>在这里我们实现的是<strong>聚焦</strong>网络爬虫，只爬取招聘的相关数据。</p>
<h2 id="5-1-业务分析"><a href="#5-1-业务分析" class="headerlink" title="5.1 业务分析"></a>5.1 业务分析</h2><p>今天要实现的是爬取 <a target="_blank" rel="noopener" href="https://www.51job.com/">https://www.51job.com/</a> 上的招聘信息。只爬取“计算机软件”和“互联网电子商务”两个行业的信息。</p>
<p>首先访问页面并搜索两个行业。结果如下</p>
<p><img src="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200429125749.png"></p>
<p>点击职位详情页，我们分析发现详情页还有一些数据需要抓取：<br>职位、公司名称、工作地点、薪资、发布时间、职位信息、公司联系方式、公司信息<br><img src="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200429125916.png"><br><img src="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200429125939.png"></p>
<h2 id="5-2-数据库表"><a href="#5-2-数据库表" class="headerlink" title="5.2 数据库表"></a>5.2 数据库表</h2><p>根据以上信息，设计数据库表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `job_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键id&#x27;</span>,</span><br><span class="line">  `company_name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;公司名称&#x27;</span>,</span><br><span class="line">  `company_addr` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;公司联系方式&#x27;</span>,</span><br><span class="line">  `company_info` text COMMENT <span class="string">&#x27;公司信息&#x27;</span>,</span><br><span class="line">  `job_name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;职位名称&#x27;</span>,</span><br><span class="line">  `job_addr` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;工作地点&#x27;</span>,</span><br><span class="line">  `job_info` text COMMENT <span class="string">&#x27;职位信息&#x27;</span>,</span><br><span class="line">  `salary_min` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;薪资范围，最小&#x27;</span>,</span><br><span class="line">  `salary_max` <span class="type">int</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;薪资范围，最大&#x27;</span>,</span><br><span class="line">  `url` <span class="type">varchar</span>(<span class="number">150</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;招聘信息详情页&#x27;</span>,</span><br><span class="line">  `<span class="type">time</span>` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;职位最近发布时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 COMMENT<span class="operator">=</span><span class="string">&#x27;招聘信息&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h2 id="5-3-实现流程"><a href="#5-3-实现流程" class="headerlink" title="5.3 实现流程"></a>5.3 实现流程</h2><p>我们需要解析职位列表页，获取职位的详情页，再解析页面获取数据。<br>获取url地址的流程如下：<br><img src="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200429130352.png"></p>
<p>但是在这里有个问题：在解析页面的时候，很可能会解析出相同的url地址(例如商品标题和商品图片超链接，而且url一样)，如果不进行处理，同样的url会解析处理多次，浪费资源。所以我们需要有一个url去重的功能</p>
<h3 id="1-Scheduler组件"><a href="#1-Scheduler组件" class="headerlink" title="1.Scheduler组件"></a>1.Scheduler组件</h3><p>WebMagic提供了Scheduler可以帮助我们解决以上问题。<br>Scheduler是WebMagic中进行URL管理的组件。一般来说，Scheduler包括两个作用：</p>
<ul>
<li>对待抓取的URL队列进行管理。</li>
<li>对已抓取的URL进行去重</li>
</ul>
<p>WebMagic内置了<strong>几个</strong>常用的<strong>Scheduler</strong>。如果你只是在本地执行规模比较小的爬虫，那么基本<strong>无需定制Scheduler</strong>，但是了解一下已经提供的几个Scheduler还是有意义的。</p>
<table>
<thead>
<tr>
<th align="center">类</th>
<th align="center">说明</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">DuplicateRemovedScheduler</td>
<td align="center">抽象基类，提供一些模板方法</td>
<td align="center">继承它可以实现自己的功能</td>
</tr>
<tr>
<td align="center">QueueScheduler</td>
<td align="center">使用内存队列保存待抓取URL</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">PriorityScheduler</td>
<td align="center">使用带有优先级的内存队列保存待抓取URL</td>
<td align="center">耗费内存较QueueScheduler更大，但是当设置了request.priority之后，只能使用PriorityScheduler才可使优先级生效</td>
</tr>
<tr>
<td align="center">FileCacheQueueScheduler</td>
<td align="center">使用文件保存抓取URL，可以在关闭程序并下次启动时，从之前抓取到的URL继续抓取</td>
<td align="center">需指定路径，会建立.urls.txt和.cursor.txt两个文件</td>
</tr>
<tr>
<td align="center">RedisScheduler</td>
<td align="center">使用Redis保存抓取队列，可进行多台机器同时合作抓取</td>
<td align="center">需要安装并启动redis</td>
</tr>
</tbody></table>
<p>去重部分被单独抽象成了一个接口：DuplicateRemover，从而可以为同一个Scheduler选择不同的去重方式，以适应不同的需要，目前提供了两种去重方式。</p>
<table>
<thead>
<tr>
<th align="center">类</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">HashSetDuplicateRemover</td>
<td align="center">使用HashSet来进行去重，占用内存较大</td>
</tr>
<tr>
<td align="center">BloomFilterDuplicateRemover</td>
<td align="center">使用BloomFilter来进行去重，占用内存较小，但是可能漏抓页面</td>
</tr>
</tbody></table>
<p>RedisScheduler是使用Redis的set进行去重，其他的Scheduler默认都使用HashSetDuplicateRemover来进行去重。</p>
<p>RedisScheduler是使用Redis的set进行去重，其他的Scheduler默认都使用HashSetDuplicateRemover来进行去重。<br>如果要使用BloomFilter，必须要加入以下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--WebMagic对布隆过滤器的支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h3 id="2-三种去重方式"><a href="#2-三种去重方式" class="headerlink" title="2.三种去重方式"></a>2.三种去重方式</h3><p>去重就有三种实现方式，那有什么不同呢？</p>
<p><strong>HashSet</strong>：使用java中的HashSet不能重复的特点去重。<strong>优点</strong>:是容易理解。使用方便。<strong>缺点</strong>：占用内存大，性能较低。<strong>默认去重方式</strong></p>
<p>示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobProcessor</span> <span class="keyword">implements</span> <span class="title">PageProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析页面</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Page page)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置相同的三个链接</span></span><br><span class="line">        page.addTargetRequest(<span class="string">&quot;https://www.jd.com/news.html?id=37319&quot;</span>);</span><br><span class="line">        page.addTargetRequest(<span class="string">&quot;https://www.jd.com/news.html?id=37319&quot;</span>);</span><br><span class="line">        page.addTargetRequest(<span class="string">&quot;https://www.jd.com/news.html?id=37319&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Site site = Site.me()</span><br><span class="line">            .setCharset(<span class="string">&quot;utf8&quot;</span>)    <span class="comment">//设置编码</span></span><br><span class="line">            .setTimeOut(<span class="number">10000</span>)   <span class="comment">//设置超时时间，单位是ms毫秒</span></span><br><span class="line">            .setRetrySleepTime(<span class="number">3000</span>)  <span class="comment">//设置重试的间隔时间</span></span><br><span class="line">            .setSleepTime(<span class="number">3</span>)      <span class="comment">//设置重试次数</span></span><br><span class="line">            ;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Site <span class="title">getSite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主函数，执行爬虫</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Spider spider = Spider.create(<span class="keyword">new</span> JobProcessor())</span><br><span class="line">                .addUrl(<span class="string">&quot;https://www.jd.com/moreSubject.aspx&quot;</span>)  <span class="comment">//设置爬取数据的页面</span></span><br><span class="line">                .thread(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        Scheduler scheduler = spider.getScheduler();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行爬虫</span></span><br><span class="line">        spider.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>布隆过滤器（BloomFilter）</strong><br>使用布隆过滤器也可以实现去重。优点是占用的内存要比使用HashSet要小的多，也适合大量数据的去重操作。<br>缺点：<strong>有误判的可能</strong>。没有重复可能会判定重复，但是重复数据一定会判定重复。</p>
<p>示例:</p>
<p>需要在<code>pom</code>文件中添加依赖:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">```xml</span><br><span class="line"><span class="comment">&lt;!--WebMagic对布隆过滤器的支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>测试方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobProcessor</span> <span class="keyword">implements</span> <span class="title">PageProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析页面</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Page page)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置相同的三个链接</span></span><br><span class="line">        page.addTargetRequest(<span class="string">&quot;https://www.jd.com/news.html?id=37319&quot;</span>);</span><br><span class="line">        page.addTargetRequest(<span class="string">&quot;https://www.jd.com/news.html?id=37319&quot;</span>);</span><br><span class="line">        page.addTargetRequest(<span class="string">&quot;https://www.jd.com/news.html?id=37319&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Site site = Site.me()</span><br><span class="line">            .setCharset(<span class="string">&quot;utf8&quot;</span>)    <span class="comment">//设置编码</span></span><br><span class="line">            .setTimeOut(<span class="number">10000</span>)   <span class="comment">//设置超时时间，单位是ms毫秒</span></span><br><span class="line">            .setRetrySleepTime(<span class="number">3000</span>)  <span class="comment">//设置重试的间隔时间</span></span><br><span class="line">            .setSleepTime(<span class="number">3</span>)      <span class="comment">//设置重试次数</span></span><br><span class="line">            ;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Site <span class="title">getSite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主函数，执行爬虫</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">         Spider spider = Spider.create(<span class="keyword">new</span> JobProcessor())</span><br><span class="line">                .addUrl(<span class="string">&quot;https://www.jd.com/moreSubject.aspx&quot;</span>)  <span class="comment">//设置爬取数据的页面</span></span><br><span class="line">                .thread(<span class="number">5</span>)</span><br><span class="line">                .setScheduler(<span class="keyword">new</span> QueueScheduler().setDuplicateRemover(<span class="keyword">new</span> BloomFilterDuplicateRemover(<span class="number">10000000</span>)));<span class="comment">//设置布隆去重过滤器，指定最多对1000万数据进行去重操作</span></span><br><span class="line"></span><br><span class="line">        Scheduler scheduler = spider.getScheduler();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行爬虫</span></span><br><span class="line">        spider.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Redis去重</strong><br>使用Redis的set进行去重。优点是速度快（Redis本身速度就很快），而且去重不会占用爬虫服务器的资源，可以处理更大数据量的数据爬取。<br>缺点：需要准备Redis服务器，增加开发和使用成本。</p>
<h3 id="3-布隆过滤器介绍与实现-了解"><a href="#3-布隆过滤器介绍与实现-了解" class="headerlink" title="3.布隆过滤器介绍与实现(了解)"></a>3.布隆过滤器介绍与实现(了解)</h3><p><strong>介绍</strong><br>布隆过滤器 (Bloom Filter)是由Burton Howard Bloom于1970年提出，它是一种space efficient的概率型数据结构，用于判断一个元素是否在集合中。在垃圾邮件过滤的黑白名单方法、爬虫(Crawler)的网址判重模块中等等经常被用到。<br>哈希表也能用于判断元素是否在集合中，但是布隆过滤器只需要哈希表的1/8或1/4的空间复杂度就能完成同样的问题。布隆过滤器可以插入元素，但不可以删除已有元素。其中的元素越多，误报率越大，但是漏报是不可能的。<br><strong>原理</strong>：<br>布隆过滤器需要的是一个位数组(和位图类似)和K个映射函数(和Hash表类似)，在初始状态时，对于长度为m的位数组array，它的所有位被置0。<br><img src="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200429133720.png"></p>
<p>对于有n个元素的集合<code>S=&#123;S1,S2...Sn&#125;</code>,通过k个映射函数<code>&#123;f1,f2,......fk&#125;</code>，将集合S中的每个元素<code>Sj(1&lt;=j&lt;=n)</code>映射为K个值<code>&#123;g1,g2...gk&#125;</code>，然后再将位数组array中相对应的<code>array[g1]</code>,<code>array[g2]......array[gk]</code>置为1：<br><img src="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200429133808.png"></p>
<p>如果要查找某个元素item是否在S中，则通过映射函数<code>&#123;f1,f2,...fk&#125;</code>得到k个值<code>&#123;g1,g2...gk&#125;</code>，然后再判断<code>array[g1],array[g2]...array[gk]</code>是否都为1，若全为1，则item在S中，否则item不在S中。</p>
<p>布隆过滤器会造成一定的误判，因为集合中的若干个元素通过映射之后得到的数值恰巧包括g1,g2,…gk，在这种情况下可能会造成误判，但是概率很小。</p>
<p><strong>实现</strong></p>
<p>以下是一个布隆过滤器的实现，可以参考:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BloomFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* BitSet初始分配2^24个bit */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_SIZE = <span class="number">1</span> &lt;&lt; <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 不同哈希函数的种子，一般应取质数 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] seeds = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">31</span>, <span class="number">37</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BitSet bits = <span class="keyword">new</span> BitSet(DEFAULT_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 哈希函数对象 */</span></span><br><span class="line">    <span class="keyword">private</span> SimpleHash[] func = <span class="keyword">new</span> SimpleHash[seeds.length];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BloomFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; seeds.length; i++) &#123;</span><br><span class="line">            func[i] = <span class="keyword">new</span> SimpleHash(DEFAULT_SIZE, seeds[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将url标记到bits中</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (SimpleHash f : func) &#123;</span><br><span class="line">            bits.set(f.hash(str), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否已经被bits标记</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(str)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> ret = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (SimpleHash f : func) &#123;</span><br><span class="line">            ret = ret &amp;&amp; bits.get(f.hash(str));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 哈希函数类 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleHash</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> cap;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> seed;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SimpleHash</span><span class="params">(<span class="keyword">int</span> cap, <span class="keyword">int</span> seed)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.cap = cap;</span><br><span class="line">            <span class="keyword">this</span>.seed = seed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// hash函数，采用简单的加权和hash</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> len = value.length();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                result = seed * result + value.charAt(i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (cap - <span class="number">1</span>) &amp; result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="6-案例实现"><a href="#6-案例实现" class="headerlink" title="6.案例实现"></a>6.案例实现</h1><h2 id="6-1-开发准备"><a href="#6-1-开发准备" class="headerlink" title="6.1 开发准备"></a>6.1 开发准备</h2><p>创建Maven工程，并加入依赖。pom.xml为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.crawler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cn-crawler-job<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--SpringMVC--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--SpringData Jpa--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--MySQL连接包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--WebMagic核心包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>us.codecraft<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webmagic-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--WebMagic扩展--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>us.codecraft<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webmagic-extension<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--WebMagic对布隆过滤器的支持--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--工具包--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--ElasticSearch--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--单元测试--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--simhash--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simhasher<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.lucene<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lucene-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在<code>resources</code>目录下，添加application.properties配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#DB Configuration:</span><br><span class="line">spring.datasource.driverClassName=com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.url=jdbc:mysql:<span class="comment">//127.0.0.1:3306/crawler</span></span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=root</span><br><span class="line"></span><br><span class="line">#JPA Configuration:</span><br><span class="line">spring.jpa.database=MySQL</span><br><span class="line">spring.jpa.show-sql=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>在<code>resources</code>目录下，增加日志文件<code>log4j.properties</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log4j.rootLogger=INFO,A1 </span><br><span class="line"></span><br><span class="line">log4j.appender.A1=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.A1.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.A1.layout.ConversionPattern=%-d&#123;yyyy-MM-dd HH:mm:ss,SSS&#125; [%t] [%c]-[%p] %m%n</span><br></pre></td></tr></table></figure>

<p>编写Pojo:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String companyName;</span><br><span class="line">    <span class="keyword">private</span> String companyAddr;</span><br><span class="line">    <span class="keyword">private</span> String companyInfo;</span><br><span class="line">    <span class="keyword">private</span> String jobName;</span><br><span class="line">    <span class="keyword">private</span> String jobAddr;</span><br><span class="line">    <span class="keyword">private</span> String jobInfo;</span><br><span class="line">    <span class="keyword">private</span> Integer salaryMin;</span><br><span class="line">    <span class="keyword">private</span> Integer salaryMax;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String time;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略get/set tostring方法</span></span><br></pre></td></tr></table></figure>

<p>编写Dao:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobInfoDao</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">JobInfo</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写Service：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobInfoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存工作信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobInfo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(JobInfo jobInfo)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据条件查询工作信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;JobInfo&gt; <span class="title">findJobInfo</span><span class="params">(JobInfo jobInfo)</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>编写Service实现类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInfoServiceImpl</span> <span class="keyword">implements</span> <span class="title">JobInfoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobInfoDao jobInfoDao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(JobInfo jobInfo)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//根据url和发布时间查询数据</span></span><br><span class="line">        JobInfo param = <span class="keyword">new</span> JobInfo();</span><br><span class="line">        param.setUrl(jobInfo.getUrl());</span><br><span class="line">        param.setTime(jobInfo.getTime());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行查询</span></span><br><span class="line">        List&lt;JobInfo&gt; list = <span class="keyword">this</span>.findJobInfo(param);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断查询结果是否为空</span></span><br><span class="line">        <span class="keyword">if</span> (list.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//如果查询结果为空，表示招聘信息数据不存在，或者已经更新了，需要新增或者更新数据库</span></span><br><span class="line">            <span class="keyword">this</span>.jobInfoDao.saveAndFlush(jobInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;JobInfo&gt; <span class="title">findJobInfo</span><span class="params">(JobInfo jobInfo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置查询条件</span></span><br><span class="line">        Example example = Example.of(jobInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行查询</span></span><br><span class="line">        List list = <span class="keyword">this</span>.jobInfoDao.findAll(example);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写引导类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableScheduling</span><span class="comment">//开启定时任务</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="6-2-功能实现"><a href="#6-2-功能实现" class="headerlink" title="6.2 功能实现"></a>6.2 功能实现</h2><p>创建一个包名为<code>task</code>的包,</p>
<p>创建工具类,处理薪资:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MathSalary</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取薪水范围</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> salaryStr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer[] getSalary(String salaryStr) &#123;</span><br><span class="line">        <span class="comment">//声明存放薪水范围的数组</span></span><br><span class="line">        Integer[] salary = <span class="keyword">new</span> Integer[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//&quot;500/天&quot;</span></span><br><span class="line">        <span class="comment">//0.8-1.2万/月</span></span><br><span class="line">        <span class="comment">//5-8千/月</span></span><br><span class="line">        <span class="comment">//5-6万/年</span></span><br><span class="line">        String date = salaryStr.substring(salaryStr.length() - <span class="number">1</span>, salaryStr.length());</span><br><span class="line">        <span class="comment">//如果是按天，则直接乘以240进行计算</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;月&quot;</span>.equals(date) &amp;&amp; !<span class="string">&quot;年&quot;</span>.equals(date)) &#123;</span><br><span class="line">            salaryStr = salaryStr.substring(<span class="number">0</span>, salaryStr.length() - <span class="number">2</span>);</span><br><span class="line">            salary[<span class="number">0</span>] = salary[<span class="number">1</span>] = str2Num(salaryStr, <span class="number">240</span>);</span><br><span class="line">            <span class="keyword">return</span> salary;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String unit = salaryStr.substring(salaryStr.length() - <span class="number">3</span>, salaryStr.length() - <span class="number">2</span>);</span><br><span class="line">        String[] salarys = salaryStr.substring(<span class="number">0</span>, salaryStr.length() - <span class="number">3</span>).split(<span class="string">&quot;-&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        salary[<span class="number">0</span>] = mathSalary(date, unit, salarys[<span class="number">0</span>]);</span><br><span class="line">        salary[<span class="number">1</span>] = mathSalary(date, unit, salarys[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> salary;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据条件计算薪水</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Integer <span class="title">mathSalary</span><span class="params">(String date, String unit, String salaryStr)</span> </span>&#123;</span><br><span class="line">        Integer salary = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断单位是否是万</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;万&quot;</span>.equals(unit)) &#123;</span><br><span class="line">            <span class="comment">//如果是万，薪水乘以10000</span></span><br><span class="line">            salary = str2Num(salaryStr, <span class="number">10000</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//否则乘以1000</span></span><br><span class="line">            salary = str2Num(salaryStr, <span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断时间是否是月</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;月&quot;</span>.equals(date)) &#123;</span><br><span class="line">            <span class="comment">//如果是月，薪水乘以12</span></span><br><span class="line">            salary = str2Num(salary.toString(), <span class="number">12</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">str2Num</span><span class="params">(String salaryStr, <span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 把字符串转为小数，必须用Number接受，否则会有精度丢失的问题</span></span><br><span class="line">            Number result = Float.parseFloat(salaryStr) * num;</span><br><span class="line">            <span class="keyword">return</span> result.intValue();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>编写url解析功能:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobProcessor</span> <span class="keyword">implements</span> <span class="title">PageProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String url = <span class="string">&quot;https://search.51job.com/list/000000,000000,0000,32%252C01,9,99,java,2,&quot;</span> +</span><br><span class="line">            <span class="string">&quot;1.html?lang=c&amp;stype=&amp;postchannel=0000&amp;workyear=99&amp;cotype=99&amp;degreefrom=99&amp;jobterm=99&amp;companysize=99&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&amp;providesalary=99&amp;lonlat=0%2C0&amp;radius=-1&amp;ord_field=0&amp;confirmdate=9&amp;fromType=&amp;dibiaoid=0&amp;address=&amp;line&quot;</span> +</span><br><span class="line">            <span class="string">&quot;=&amp;specialarea=00&amp;from=&amp;welfare=&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Page page)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//解析页面，获取招聘信息详情的url地址</span></span><br><span class="line">        <span class="comment">//获取html中的div标签，并且div标签的id等于resultList下，div的class等于el的标签。</span></span><br><span class="line">        List&lt;Selectable&gt; list = page.getHtml().css(<span class="string">&quot;div#resultList div.el&quot;</span>).nodes(); <span class="comment">//nodes 获取选择器的所有节点</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断获取到的集合是否为空</span></span><br><span class="line">        <span class="keyword">if</span> (list.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果为空，表示这是招聘详情页,解析页面，获取招聘详情信息，保存数据</span></span><br><span class="line">            <span class="keyword">this</span>.saveJobInfo(page);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//如果不为空，表示这是列表页,解析出详情页的url地址，放到任务队列中</span></span><br><span class="line">            <span class="keyword">for</span> (Selectable selectable : list) &#123;</span><br><span class="line">                <span class="comment">//获取url地址</span></span><br><span class="line">                String jobInfoUrl = selectable.links().toString();</span><br><span class="line">                <span class="comment">//把获取到的url地址放到任务队列中</span></span><br><span class="line">                page.addTargetRequest(jobInfoUrl);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取下一页的url</span></span><br><span class="line">            String bkUrl = page.getHtml().css(<span class="string">&quot;div.p_in li.bk&quot;</span>).nodes().get(<span class="number">1</span>).links().toString(); <span class="comment">//一共两条符合数据，第一条是上一页超链接，第二条是下一页超链接。0代表第一条，1代表第二条</span></span><br><span class="line">            <span class="comment">//把url放到任务队列中</span></span><br><span class="line">            page.addTargetRequest(bkUrl);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String html = page.getHtml().toString();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析页面，获取招聘详情信息，保存数据</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveJobInfo</span><span class="params">(Page page)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建招聘详情对象</span></span><br><span class="line">        JobInfo jobInfo  = <span class="keyword">new</span> JobInfo();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析页面</span></span><br><span class="line">        Html html = page.getHtml();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取数据，封装到对象中</span></span><br><span class="line">        <span class="comment">//获取html中的div标签，并且div标签的id等于cn，并找到div下的p标签的class等于cname的P标签，找到该p标签对应的a标签内容</span></span><br><span class="line">        jobInfo.setCompanyName(html.css(<span class="string">&quot;div.cn p.cname a&quot;</span>,<span class="string">&quot;text&quot;</span>).toString());  <span class="comment">//唯一的值，可以用webmagic</span></span><br><span class="line">        jobInfo.setCompanyAddr(Jsoup.parse(html.css(<span class="string">&quot;div.bmsg&quot;</span>).nodes().get(<span class="number">1</span>).toString()).text());  <span class="comment">//jsoup解析，有两种数据，所以用jsoup</span></span><br><span class="line">        jobInfo.setCompanyInfo(Jsoup.parse(html.css(<span class="string">&quot;div.tmsg&quot;</span>).toString()).text());  <span class="comment">//jsoup解析</span></span><br><span class="line">        jobInfo.setJobName(html.css(<span class="string">&quot;div.cn h1&quot;</span>,<span class="string">&quot;text&quot;</span>).toString());</span><br><span class="line">        jobInfo.setJobAddr(html.css(<span class="string">&quot;div.cn span.lname&quot;</span>,<span class="string">&quot;text&quot;</span>).toString());</span><br><span class="line">        jobInfo.setJobInfo(Jsoup.parse(html.css(<span class="string">&quot;div.job_msg&quot;</span>).toString()).text());</span><br><span class="line">        jobInfo.setUrl(page.getUrl().toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取薪资</span></span><br><span class="line">        Integer[] salary = MathSalary.getSalary(html.css(<span class="string">&quot;div.cn strong&quot;</span>, <span class="string">&quot;text&quot;</span>).toString());</span><br><span class="line">        jobInfo.setSalaryMin(salary[<span class="number">0</span>]);</span><br><span class="line">        jobInfo.setSalaryMax(salary[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取发布时间</span></span><br><span class="line">        String time = Jsoup.parse(html.css(<span class="string">&quot;div.t1 span&quot;</span>).regex(<span class="string">&quot;.*发布&quot;</span>).toString()).text();</span><br><span class="line">        jobInfo.setTime(time.substring(<span class="number">0</span>,time.length()-<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//把结果保存起来,保存到了resultItems中</span></span><br><span class="line">        page.putField(<span class="string">&quot;jobInfo&quot;</span>,jobInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Site site = Site.me()</span><br><span class="line">            .setCharset(<span class="string">&quot;gbk&quot;</span>)<span class="comment">//设置编码</span></span><br><span class="line">            .setTimeOut(<span class="number">10</span> * <span class="number">1000</span>)<span class="comment">//设置超时时间</span></span><br><span class="line">            .setRetrySleepTime(<span class="number">3000</span>)<span class="comment">//设置重试的间隔时间</span></span><br><span class="line">            .setRetryTimes(<span class="number">3</span>);<span class="comment">//设置重试的次数</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Site <span class="title">getSite</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> site;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SpringDataPipeline springDataPipeline;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//initialDelay当任务启动后，等等多久执行方法</span></span><br><span class="line">    <span class="comment">//fixedDelay每个多久执行方法</span></span><br><span class="line">    <span class="meta">@Scheduled(initialDelay = 1000, fixedDelay = 100 * 1000)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Spider.create(<span class="keyword">new</span> JobProcessor())</span><br><span class="line">                .addUrl(url)</span><br><span class="line">                .setScheduler(<span class="keyword">new</span> QueueScheduler().setDuplicateRemover(<span class="keyword">new</span> BloomFilterDuplicateRemover(<span class="number">100000</span>)))  <span class="comment">//布隆过滤器 10w条</span></span><br><span class="line">                .thread(<span class="number">10</span>)</span><br><span class="line">                .run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-3-使用和定制Pipeline"><a href="#6-3-使用和定制Pipeline" class="headerlink" title="6.3 使用和定制Pipeline"></a>6.3 使用和定制Pipeline</h2><p>在WebMagic中，Pileline是抽取结束后，进行处理的部分，它主要用于抽取结果的保存，也可以定制Pileline可以实现一些通用的功能。在这里我们会定制Pipeline实现数据导入到数据库中</p>
<h3 id="1-Pipeline输出"><a href="#1-Pipeline输出" class="headerlink" title="1.Pipeline输出"></a>1.Pipeline输出</h3><p>ipeline的接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Pipeline</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ResultItems保存了抽取结果，它是一个Map结构，</span></span><br><span class="line">    <span class="comment">// 在page.putField(key,value)中保存的数据，</span></span><br><span class="line">    <span class="comment">//可以通过ResultItems.get(key)获取</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ResultItems resultItems, Task task)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，Pipeline其实就是将PageProcessor抽取的结果，继续进行了处理的，其实在Pipeline中完成的功能，你基本上也可以直接在PageProcessor实现，那么为什么会有Pipeline？有几个原因：<br>1.为了模块分离<br>“页面抽取”和“后处理、持久化”是爬虫的两个阶段，将其分离开来，一个是代码结构比较清晰，另一个是以后也可能将其处理过程分开，分开在独立的线程以至于不同的机器执行。</p>
<p>2.Pipeline的功能比较固定，更容易做成通用组件<br>每个页面的抽取方式千变万化，但是后续处理方式则比较固定，例如保存到文件、保存到数据库这种操作，这些对所有页面都是通用的。</p>
<p>在WebMagic里，一个Spider可以有多个Pipeline，使用Spider.addPipeline()即可增加一个Pipeline。这些Pipeline都会得到处理，例如可以使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spider.addPipeline(<span class="keyword">new</span> ConsolePipeline()).addPipeline(<span class="keyword">new</span> FilePipeline())</span><br></pre></td></tr></table></figure>
<p>实现输出结果到控制台，并且保存到文件的目标。</p>
<h3 id="2-已有的Pipeline"><a href="#2-已有的Pipeline" class="headerlink" title="2.已有的Pipeline"></a>2.已有的Pipeline</h3><p>WebMagic中就已经提供了控制台输出、保存到文件、保存为JSON格式的文件几种通用的Pipeline。</p>
<table>
<thead>
<tr>
<th align="center">类</th>
<th align="center">说明</th>
<th align="center">备注</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ConsolePipeline</td>
<td align="center">输出结果到控制台</td>
<td align="center">抽取结果需要实现toString方法</td>
</tr>
<tr>
<td align="center">FilePipeline</td>
<td align="center">保存结果到文件</td>
<td align="center">抽取结果需要实现toString方法</td>
</tr>
<tr>
<td align="center">JsonFilePipeline</td>
<td align="center">JSON格式保存结果到文件</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">ConsolePageModelPipeline</td>
<td align="center">(注解模式)输出结果到控制台</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">FilePageModelPipeline</td>
<td align="center">(注解模式)保存结果到文件</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">JsonFilePageModelPipeline</td>
<td align="center">(注解模式)JSON格式保存结果到文件</td>
<td align="center">想持久化的字段需要有getter方法</td>
</tr>
</tbody></table>
<h3 id="3-自定义Pipeline导入数据"><a href="#3-自定义Pipeline导入数据" class="headerlink" title="3.自定义Pipeline导入数据"></a>3.自定义Pipeline导入数据</h3><p>在<code>task</code>包下创建:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringDataPipeline</span>  <span class="keyword">implements</span> <span class="title">Pipeline</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobInfoService jobInfoService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ResultItems resultItems, Task task)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取封装好的招聘详情对象</span></span><br><span class="line">        JobInfo jobInfo = resultItems.get(<span class="string">&quot;jobInfo&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断数据是否不为空</span></span><br><span class="line">        <span class="keyword">if</span> (jobInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//如果不为空把数据保存到数据库中</span></span><br><span class="line">            <span class="keyword">this</span>.jobInfoService.save(jobInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改<code>JobProcessor</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注入自定义springDataPipeline</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> SpringDataPipeline springDataPipeline;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//initialDelay当任务启动后，等等多久执行方法</span></span><br><span class="line">  <span class="comment">//fixedDelay每个多久执行方法</span></span><br><span class="line">  <span class="comment">//@Scheduled(initialDelay = 1000, fixedDelay = 100 * 1000)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Spider.create(<span class="keyword">new</span> JobProcessor())</span><br><span class="line">              .addUrl(url)</span><br><span class="line">              .setScheduler(<span class="keyword">new</span> QueueScheduler().setDuplicateRemover(<span class="keyword">new</span> BloomFilterDuplicateRemover(<span class="number">100000</span>)))</span><br><span class="line">              .thread(<span class="number">10</span>)</span><br><span class="line">              .addPipeline(<span class="keyword">this</span>.springDataPipeline)  <span class="comment">//自定义输出方式，入库</span></span><br><span class="line">              .run();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h1 id="7-定时任务"><a href="#7-定时任务" class="headerlink" title="7.定时任务"></a>7.定时任务</h1><p>我们使用的是Spring内置的Spring Task，这是Spring3.0加入的定时任务功能。我们使用注解的方式定时启动爬虫进行数据爬取。<br>我们使用的是 <strong>@Scheduled</strong>注解，其属性如下：<br>1）<code>cron</code>：cron表达式，指定任务在特定时间执行；<br>2）<code>fixedDelay</code>：上一次任务执行完后多久再执行，参数类型为long，单位ms<br>3）<code>fixedDelayStrin</code>g<code>：与fixedDelay含义一样，只是参数类型变为String 4）</code>fixedRate<code>：按一定的频率执行任务，参数类型为long，单位ms 5）</code>fixedRateString<code>: 与fixedRate的含义一样，只是将参数类型变为String 6）</code>initialDelay<code>：延迟多久再第一次执行任务，参数类型为long，单位ms 7）</code>initialDelayString<code>：与initialDelay的含义一样，只是将参数类型变为String 8）</code>zone`：时区，默认为当前时区，一般没有用到</p>
<p>我们这里的使用比较简单，固定的间隔时间来启动爬虫。例如可以实现项目启动后，每隔一小时启动一次爬虫。</p>
<p>但是有可能业务要求更高，并不是<strong>定时定期处理</strong>，而是在<strong>特定的时间进行处理</strong>，这个时候我们之前的使用方式就不能满足需求了。例如我要在工作日（周一到周五）的晚上八点执行。这时我们就需要Cron表达式了。</p>
<h2 id="7-1-Cron表达式"><a href="#7-1-Cron表达式" class="headerlink" title="7.1 Cron表达式"></a>7.1 Cron表达式</h2><p>cron的表达式是字符串，实际上是由七子表达式，描述个别细节的时间表。这些子表达式是分开的空白，代表：</p>
<ol>
<li> Seconds</li>
<li> Minutes</li>
<li> Hours</li>
<li> Day-of-Month</li>
<li> Month</li>
<li> Day-of-Week</li>
<li> Year (可选字段)<br>例: <code>0 0 12 ? * WED</code>:在每星期三下午12:00 执行<br><code>*</code>:代表整个时间段</li>
</ol>
<p>每一个字段都有一套可以指定有效值，如<br><code>Seconds (秒)</code>：可以用数字0－59 表示<br><code>Minutes(分)</code>    ：可以用数字0－59 表示<br><code>Hours(时)</code>：可以用数字0-23表示<br><code>Day-of-Month(天)</code>：可以用数字1-31 中的任一一个值，但要注意一些特别的月份<br><code>Month(月)</code> ：可以用0-11 或用字符串:JAN, FEB, MAR, APR, MAY, JUN, JUL, AUG, SEP, OCT, NOV, DEC<br><code>Day-of-Week(天)</code>：可以用数字1-7表示（1 ＝ 星期日）或用字符口串:SUN, MON, TUE, WED, THU, FRI, SAT</p>
<p><code>“/”</code>：为特别单位，则表示为<code>“每”如“0/15”表示每隔15分钟（或秒）执行一次</code>,<code>“0”表示为从“0”分（或秒）开始</code>, <code>“3/20”表示表示每隔20分钟（或秒）执行一次</code>，<code>“3”表示从第3分钟（或秒）开始执行</code><br><code>“?”：表示每月的某一天，或第周的某一天</code><br><code>“L”：</code>用于每月，或每周，表示为<code>每月的最后一天</code>，或<code>每个月的最后星期几</code>如“6L”表示“每月的最后一个星期五” </p>
<p>例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从0秒开始，每隔5秒执行一次、每分钟、每小时、每天、每月、每周都执行。第七个年可以省略</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/5 * * * * *&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       System.out.println(LocalDateTime.now()+<span class="string">&quot;任务执行了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Lyouth</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.liuyu.pw/blog/posts/3406920255.html">https://www.liuyu.pw/blog/posts/3406920255.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.liuyu.pw/blog" target="_blank">Lyouth - 贵在坚持</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/%E7%88%AC%E8%99%AB/">爬虫</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/InternetWorm/20200424113627.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/blog/posts/3041119952.html"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/RabbitMQ/20200503190717.jpg" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">RabbitMQ</div></div></a></div><div class="next-post pull-right"><a href="/blog/posts/2393724542.html"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/liuyu1994/Picture/hexo/Butterflys/post/MongoDB/20200405154903.jpg" onerror="onerror=null;src='/blog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MongoDB</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB"><span class="toc-number">1.</span> <span class="toc-text">1.网络爬虫</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%AD%A6%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 为什么学网络爬虫</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E7%88%AC%E8%99%AB%E5%88%86%E7%B1%BB"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 爬虫分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%80%9A%E7%94%A8%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.通用网络爬虫</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%81%9A%E7%84%A6%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.聚焦网络爬虫</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%A2%9E%E9%87%8F%E5%BC%8F%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.增量式网络爬虫</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Deep-Web-%E7%88%AC%E8%99%AB"><span class="toc-number">1.3.4.</span> <span class="toc-text">4.Deep Web 爬虫</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-HttpClient"><span class="toc-number">2.</span> <span class="toc-text">2.HttpClient</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%85%A5%E9%97%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 入门程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-GET%E8%AF%B7%E6%B1%82"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 GET请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E5%B8%A6%E5%8F%82%E6%95%B0%E7%9A%84GET%E8%AF%B7%E6%B1%82"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 带参数的GET请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-POST%E8%AF%B7%E6%B1%82"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 POST请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E5%B8%A6%E5%8F%82%E6%95%B0%E7%9A%84POST%E8%AF%B7%E6%B1%82"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 带参数的POST请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">2.6.</span> <span class="toc-text">2.6 连接池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0"><span class="toc-number">2.7.</span> <span class="toc-text">2.7 请求参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-JSOUP"><span class="toc-number">3.</span> <span class="toc-text">3.JSOUP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-jsoup%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 jsoup介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-jsoup%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 jsoup解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%A7%A3%E6%9E%90URL"><span class="toc-number">3.2.1.</span> <span class="toc-text">1 解析URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%A7%A3%E6%9E%90%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">3.2.2.</span> <span class="toc-text">2 解析字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%A7%A3%E6%9E%90%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.3.</span> <span class="toc-text">3 解析文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8dom%E6%96%B9%E5%BC%8F%E9%81%8D%E5%8E%86%E6%96%87%E6%A1%A3"><span class="toc-number">3.2.4.</span> <span class="toc-text">4 使用dom方式遍历文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BD%BF%E7%94%A8%E9%80%89%E6%8B%A9%E5%99%A8%E8%AF%AD%E6%B3%95%E6%9F%A5%E6%89%BE%E5%85%83%E7%B4%A0"><span class="toc-number">3.2.5.</span> <span class="toc-text">5 使用选择器语法查找元素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Selector%E9%80%89%E6%8B%A9%E5%99%A8%E6%A6%82%E8%BF%B0"><span class="toc-number">3.2.6.</span> <span class="toc-text">6 Selector选择器概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-Selector%E9%80%89%E6%8B%A9%E5%99%A8%E7%BB%84%E5%90%88%E4%BD%BF%E7%94%A8"><span class="toc-number">3.2.7.</span> <span class="toc-text">7 Selector选择器组合使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E7%88%AC%E8%99%AB%E6%A1%88%E4%BE%8B"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 爬虫案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E5%88%86%E6%9E%90"><span class="toc-number">3.3.1.</span> <span class="toc-text">1.数据库表分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">3.3.2.</span> <span class="toc-text">2.添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.添加配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%BC%96%E5%86%99POJO"><span class="toc-number">3.3.4.</span> <span class="toc-text">4.编写POJO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E7%BC%96%E5%86%99DAO"><span class="toc-number">3.3.5.</span> <span class="toc-text">5.编写DAO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%BC%96%E5%86%99Service"><span class="toc-number">3.3.6.</span> <span class="toc-text">6.编写Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E7%BC%96%E5%86%99%E5%BC%95%E5%AF%BC%E7%B1%BB"><span class="toc-number">3.3.7.</span> <span class="toc-text">7.编写引导类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%B0%81%E8%A3%85HttpClient"><span class="toc-number">3.3.8.</span> <span class="toc-text">8.封装HttpClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E6%8A%93%E5%8F%96"><span class="toc-number">3.3.9.</span> <span class="toc-text">9.实现数据抓取</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-WebMagic"><span class="toc-number">4.</span> <span class="toc-text">4.WebMagic</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-WebMagic%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 WebMagic介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 架构介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-WebMagic%E7%9A%84%E5%9B%9B%E4%B8%AA%E7%BB%84%E4%BB%B6"><span class="toc-number">4.2.1.</span> <span class="toc-text">1.WebMagic的四个组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%94%A8%E4%BA%8E%E6%95%B0%E6%8D%AE%E6%B5%81%E8%BD%AC%E7%9A%84%E5%AF%B9%E8%B1%A1"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.用于数据流转的对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3%E5%AE%9E%E7%8E%B0PageProcessor"><span class="toc-number">4.3.</span> <span class="toc-text">4.3实现PageProcessor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">4.3.1.</span> <span class="toc-text">1.入门案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8A%BD%E5%8F%96%E5%85%83%E7%B4%A0Selectable"><span class="toc-number">4.3.2.</span> <span class="toc-text">2.抽取元素Selectable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%8A%BD%E5%8F%96%E5%85%83%E7%B4%A0Selectable%E5%AF%B9%E5%BA%94API"><span class="toc-number">4.3.3.</span> <span class="toc-text">3.抽取元素Selectable对应API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%8E%B7%E5%8F%96%E7%BB%93%E6%9E%9CAPI"><span class="toc-number">4.3.4.</span> <span class="toc-text">4.获取结果API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%8E%B7%E5%8F%96%E9%93%BE%E6%8E%A5"><span class="toc-number">4.3.5.</span> <span class="toc-text">5.获取链接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4%E4%BD%BF%E7%94%A8Pipeline%E4%BF%9D%E5%AD%98%E7%BB%93%E6%9E%9C"><span class="toc-number">4.4.</span> <span class="toc-text">4.4使用Pipeline保存结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5%E7%88%AC%E8%99%AB%E7%9A%84%E9%85%8D%E7%BD%AE%E3%80%81%E5%90%AF%E5%8A%A8%E5%92%8C%E7%BB%88%E6%AD%A2"><span class="toc-number">4.5.</span> <span class="toc-text">4.5爬虫的配置、启动和终止</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Spider"><span class="toc-number">4.5.1.</span> <span class="toc-text">1.Spider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%88%AC%E8%99%AB%E9%85%8D%E7%BD%AESite"><span class="toc-number">4.5.2.</span> <span class="toc-text">2.爬虫配置Site</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81%E5%8F%82%E8%80%83"><span class="toc-number">4.6.</span> <span class="toc-text">4.6 测试代码参考</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">5.案例分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E4%B8%9A%E5%8A%A1%E5%88%86%E6%9E%90"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 业务分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 数据库表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 实现流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Scheduler%E7%BB%84%E4%BB%B6"><span class="toc-number">5.3.1.</span> <span class="toc-text">1.Scheduler组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%89%E7%A7%8D%E5%8E%BB%E9%87%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">5.3.2.</span> <span class="toc-text">2.三种去重方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E4%BA%86%E8%A7%A3"><span class="toc-number">5.3.3.</span> <span class="toc-text">3.布隆过滤器介绍与实现(了解)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">6.案例实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%BC%80%E5%8F%91%E5%87%86%E5%A4%87"><span class="toc-number">6.1.</span> <span class="toc-text">6.1 开发准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.2.</span> <span class="toc-text">6.2 功能实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E4%BD%BF%E7%94%A8%E5%92%8C%E5%AE%9A%E5%88%B6Pipeline"><span class="toc-number">6.3.</span> <span class="toc-text">6.3 使用和定制Pipeline</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Pipeline%E8%BE%93%E5%87%BA"><span class="toc-number">6.3.1.</span> <span class="toc-text">1.Pipeline输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B7%B2%E6%9C%89%E7%9A%84Pipeline"><span class="toc-number">6.3.2.</span> <span class="toc-text">2.已有的Pipeline</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%87%AA%E5%AE%9A%E4%B9%89Pipeline%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">6.3.3.</span> <span class="toc-text">3.自定义Pipeline导入数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">7.</span> <span class="toc-text">7.定时任务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-Cron%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">7.1.</span> <span class="toc-text">7.1 Cron表达式</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2021 By Lyouth</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/blog/js/utils.js"></script><script src="/blog/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script></div></body></html>